Ibles.package("Ibles.models");Ibles.models.FileModel=Backbone.Model.extend({defaults:function(){return{id:null,downloadUrl:null,tinyUrl:null,squareUrl:null,square2Url:null,square3Url:null,thumbUrl:null,smallUrl:null,mediumUrl:null,rectangle1Url:null,largeUrl:null}}});Ibles.package("Ibles.collections");Ibles.collections.FileCollection=Backbone.Collection.extend({model:Ibles.models.FileModel,initialize:function(attributes,options){this.uuid=_.uniqueId("fc")}});Ibles.package("Ibles.models","Ibles.collections");Ibles.models.MemberModel=Backbone.Model.extend({defaults:function(){return{id:null,screenName:null,following:false,views:0,commentCount:0,featuredCount:0,favoritesCount:0,instructablesCount:0,draftsCount:0,publishedCollectionsCount:0,draftCollectionsCount:0,collaborationsCount:0,followersCount:0,subscriptionsCount:0}},initialize:function(attributes,options){options=options||{};if(options.fetchAuthorStats)this.fetchAuthorStats();if(options.fetchUserData)this.fetchUserData()},fetchAuthorStats:function(){var self=this;Ibles.API.getRequest("showAuthorStats",{screenName:this.get("screenName")}).done(function(data){self.set(data)}).always(function(){self.trigger("authorStatsSynced")})},fetchUserData:function(){if(Ibles.session.authenticated()&&(Ibles.session.isAdmin()||Ibles.session.get("screenName")===this.get("screenName"))){var self=this;Ibles.API.getRequest("showAuthorUserData",{screenName:this.get("screenName")}).done(function(data){self.set(data)}).always(function(){self.trigger("userDataSynced")})}},toggleFollowing:function(){var self=this;return Ibles.API.postRequest("setFollowing",{memberId:this.get("id"),following:!this.get("following")},{success:function(data){self.set({following:data.following})}})},isFollowing:function(){var that=this;return Ibles.API.getRequest("isFollowing",{screenName:this.get("screenName")},{success:function(data){that.set({following:data.isFollowing||false})}})},purgeFromCache:function(){return Ibles.API.jsonPostRequest("purgeCaches",{ids:[this.get("id")]})},sendPrivateMessage:function(msgSubject,msgBody,inReplyToId){var postData={posted:(new Date).getTime(),body:Ibles.paragraphize(msgBody.replace(/<\/?[^>]+(>|$)/g,"")),subject:msgSubject.replace(/<\/?[^>]+(>|$)/g,""),recipientId:this.get("id")},self=this;if(!_.isEmpty(inReplyToId)){postData["inReplyToId"]=inReplyToId}return Ibles.API.baseAjaxPostRequest("/edit/","compose",postData,{success:function(){self.trigger("privateMessageSent")},error:function(data){self.trigger("privateMessageError")}})}});Ibles.collections.MemberCollection=Backbone.Collection.extend({model:Ibles.models.MemberModel});Ibles.package("Ibles.models");Ibles.models.BaseInstructableModel=Backbone.Model.extend({defaults:function(){return{id:null,title:null,urlString:null,showUrl:null,editUrl:null,fullUrl:null,author:null,type:null,status:null,category:null,channel:null,publishDate:null,favorite:false,flagged:false,fetchUserData:false,fetchStats:false}},initialize:function(attributes,options){options=_.clone(options||{});this.author=new Ibles.models.MemberModel(this.get("author"));this.set({favorite:attributes&&attributes.favorite});if(this.get("fetchUserData"))this.fetchUserData();if(this.get("fetchStats"))this.fetchStats()},fetch:function(){var self=this;return Ibles.API.getRequest("showInstructableModel",{id:this.get("id")}).done(function(data){self.set(data);if(data.author)self.author.set(data.author)})},fetchUserData:function(){if(Ibles.session.authenticated()){var self=this;Ibles.API.getRequest("showInstructableUserData",{id:this.get("id"),rand:Math.round((new Date).getTime()/1e3)}).done(function(data){if(data["status"]==="LIMBO"&&!_.isUndefined(data["limboDate"])){data["status"]="SPAM"}_.extend(Ibles.pageContext.ibleData,data);self.set(data);self.author.set({following:data.following})}).always(function(){self.trigger("userDataSynced")})}},fetchStats:function(){var that=this;return Ibles.API.getRequest("getIbleStats",{id:this.get("id")},{success:function(data){that.set(data)}},["views","favorites","comments"])},flagAction:function(){var self=this;return Ibles.API.ajaxRequest("flag",{entryID:this.get("id"),action:"SET",flag:this.get("flaggedAs")},{success:function(){self.set({flagged:true})}})},favoriteAction:function(){var self=this;return Ibles.API.ajaxRequest("favorite",{entryId:this.get("id")},{success:function(){self.set({favorite:!self.get("favorite")})}})},isFavorite:function(){var self=this;return Ibles.API.getRequest("isFavorite",{id:this.get("id")},{success:function(data){self.set({favorite:data["isFavorite"]})}})},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);json.url=Ibles.reverseUrls.ibleUrl(json.id);return json}});Ibles.package("Ibles.models");Ibles.models.InstructableModel=Ibles.models.BaseInstructableModel.fullExtend({defaults:function(){return{disableComments:false,allSteps:false,currentStepIndex:0}},initialize:function(attributes,options){this._super(attributes,options);this.set({fullUrl:Ibles.pageContext.remoteHost+this.getUrl()})},getUrl:function(){var urls=Ibles.reverseUrls;return this.get("status")==="UNPUBLISHED"?urls.previewUrl(this.get("id")):urls.ibleUrl(this.get("urlString")||this.get("id"))},getEditUrl:function(){return this.get("type")==="Guide"?Ibles.reverseUrls.collectionEditUrl(this.get("id")):Ibles.reverseUrls.ibleEditUrl(this.get("id"))}});Ibles.package("Ibles.collections");Ibles.collections.InstructableCollection=Backbone.Collection.extend({model:Ibles.models.InstructableModel,initialize:function(attributes,options){var opts=_.clone(options||{})}});Ibles.package("Ibles.models");Ibles.models.LessonProgressDetailModel=Backbone.Model.extend({unserializableKeys:["optional"],defaults:function(){return{id:null,completed:false,optional:false}},isOptional:function(){return this.get("optional")},isCompleted:function(){return this.get("completed")},toJSON:function(options){return this.omit(this.unserializableKeys)},clearExtraKeys:function(options){_.each(this.attributes,function(val,key){if(!_.contains(_.keys(this.defaults()),key)){this.unset(key,options)}},this)}});Ibles.package("Ibles.collections");Ibles.collections.LessonProgressDetailCollection=Backbone.Collection.extend({model:Ibles.models.LessonProgressDetailModel,allCompleted:function(){return this.every(function(model){return model.isOptional()||model.isCompleted()})},filterCompleted:function(){return _.filter(this.filterRequired(),function(model){return model.isCompleted()})},filterRequired:function(){return this.filter(function(model){return!model.isOptional()})},anyCompleted:function(){return _.some(this.filterRequired(),function(model){return model.get("completed")})},percentComplete:function(){var totalCount=this.filterRequired().length,completedCount=this.filterCompleted().length;return totalCount===0?0:Math.round(completedCount/totalCount*100)}});Ibles.package("Ibles.models");Ibles.models.LessonProgressMarkerModel=Backbone.Model.extend({defaults:function(){return{completed:false}},initialize:function(attributes,options){this.registerProgressMarker()},getProgressId:function(){return null},registerProgressMarker:function(){Ibles.Events.trigger("lessonProgress:registerMarker",this)},markCompleted:function(extraProps){this.set(_.extend({completed:true},extraProps||{}));Ibles.Events.trigger("lessonProgress:markerCompleted",this,extraProps||{})},undoCompleted:function(){this.set({completed:false});Ibles.Events.trigger("lessonProgress:markerUndoCompleted",this)},isCompleted:function(){return!!this.get("completed")},isOptional:function(){return false}});Ibles.package("Ibles.collections");Ibles.collections.LessonProgressMarkerCollection=Backbone.Collection.extend({model:Ibles.models.LessonProgressMarkerModel});Ibles.package("Ibles.views","Ibles.models");Ibles.models.LessonScrollMarkerModel=Ibles.models.LessonProgressMarkerModel.fullExtend({getProgressId:function(){return"scroll-to-end"}});Ibles.views.LessonScrollMarkerView=Backbone.View.extend({initialize:function(){this.model=new Ibles.models.LessonScrollMarkerModel;this.setupScroll()},setupScroll:function(){var completed=false,self=this;$(window).scroll(_.debounce(function(){if(!completed){var winBottom=$(window).scrollTop()+$(window).height(),documentHeight=$(document).height(),pagerOffset=$("#lesson-nav").offset().top;if(winBottom>documentHeight-(documentHeight-pagerOffset)){self.model.markCompleted();completed=true}}},250))}});Ibles.package("Ibles.models");Ibles.models.ProgressModel=Backbone.Model.extend({defaults:function(){return{isEnrolled:false,progressStatus:null,progressDetail:[]}},resetDetails:function(model,value,options){this.details.reset(this.get("progressDetail"))},save:function(params){return Ibles.API.jsonPostRequest("courseProgress",params)},getNextProgressStatus:function(){var currentStatus=this.get("progressStatus"),newStatus=currentStatus;if(_.isEmpty(currentStatus)||currentStatus==="NOT_STARTED"){newStatus="IN_PROGRESS"}if(currentStatus!=="COMPLETE"&&this.details.allCompleted()){newStatus="COMPLETE"}return newStatus},isCompleted:function(){return this.get("progressStatus")==="COMPLETE"},notStarted:function(){var progressStatus=this.get("progressStatus");return(_.isEmpty(progressStatus)||progressStatus==="NOT_STARTED")&&!this.details.anyCompleted()},allDetailsCompleted:function(){return this.details.allCompleted()},percentComplete:function(){return this.details.percentComplete()}});Ibles.package("Ibles.models");Ibles.models.LessonProgressModel=Ibles.models.ProgressModel.fullExtend({defaults:function(){return{lessonId:null}},initialize:function(attributes,options){this.details=new Ibles.collections.LessonProgressDetailCollection(this.get("progressDetail"));this.markers=new Ibles.collections.LessonProgressMarkerCollection([]);this.listenTo(this,"change:progressDetail",this.resetDetails);this.listenTo(this.details,"change",this.onDetailsChange);this.listenTo(Ibles.Events,"lessonProgress:registerMarker",this.registerMarker);this.listenTo(Ibles.Events,"lessonProgress:markerCompleted",this.markerCompleted);this.listenTo(Ibles.Events,"lessonProgress:markerUndoCompleted",this.markerUndoCompleted)},registerMarker:function(markerModel){if(this.validMarker(markerModel)){var progressId=markerModel.getProgressId(),optional=markerModel.isOptional(),existingDetail=this.details.get(progressId);if(_.isEmpty(existingDetail)){this.details.add({id:progressId,optional:optional})}else{existingDetail.set({optional:optional},{silent:true});markerModel.set(_.omit(existingDetail.attributes,"id"),{silent:true})}this.markers.add(markerModel)}},markerCompleted:function(markerModel,extraProps){if(this.validMarker(markerModel)){var progressId=markerModel.getProgressId(),existingDetail=this.details.get(progressId);if(!_.isEmpty(existingDetail)){extraProps=extraProps||{};existingDetail.set(_.extend({completed:true},extraProps));if(this.details.allCompleted()){Ibles.Events.trigger("courseProgress:markLessonComplete",{lessonId:this.get("lessonId")})}else{Ibles.Events.trigger("courseProgress:markLessonInProgress",{lessonId:this.get("lessonId")})}}}},markerUndoCompleted:function(markerModel){if(this.validMarker(markerModel)){var progressId=markerModel.getProgressId(),existingDetail=this.details.get(progressId);if(!_.isEmpty(existingDetail)){existingDetail.clearExtraKeys({silent:true});existingDetail.set({completed:false})}}},validMarker:function(markerModel){return markerModel instanceof Ibles.models.LessonProgressMarkerModel&&!_.isEmpty(markerModel.getProgressId())},onDetailsChange:function(){this.save({progressStatus:this.getNextProgressStatus(),progressDetail:this.details.toJSON()})},markStarted:function(){this.save({progressStatus:"IN_PROGRESS"});Ibles.Events.trigger("courseProgress:markLessonInProgress",{lessonId:this.get("lessonId")})},markCompleted:function(){this.save({progressStatus:"COMPLETE"});Ibles.Events.trigger("courseProgress:markLessonComplete",{lessonId:this.get("lessonId")})},save:function(attributes){var attr=attributes||{},that=this;return this._super(_.extend({objectId:this.get("lessonId")},attr)).done(function(){that.set(_.extend({isEnrolled:true},attr))})}});Ibles.package("Ibles.models");Ibles.models.CourseProgressDetailModel=Backbone.Model.extend({defaults:function(){return{id:null,status:"NOT_STARTED"}},isInProgress:function(){return this.get("status")==="IN_PROGRESS"},isComplete:function(){return this.get("status")==="COMPLETE"}});Ibles.package("Ibles.collections");Ibles.collections.CourseProgressDetailCollection=Backbone.Collection.extend({model:Ibles.models.CourseProgressDetailModel,allCompleted:function(){return this.every(function(model){return model.get("status")==="COMPLETE"})},filterCompleted:function(){return this.where({status:"COMPLETE"})},percentComplete:function(){var totalCount=this.length,completedCount=this.filterCompleted().length;return totalCount===0?0:Math.round(completedCount/totalCount*100)}});Ibles.package("Ibles.models");Ibles.models.CourseProgressModel=Ibles.models.ProgressModel.fullExtend({defaults:function(){return{courseId:null,lessons:[],patch:null}},initialize:function(attributes,options){_.bindAll(this,"updateDetailFromLessons");this.details=new Ibles.collections.CourseProgressDetailCollection(this.get("progressDetail"));this.listenTo(this,"change:progressDetail",this.resetDetails);this.listenTo(this.details,"change",this.onDetailsChange);this.listenTo(this,"change:lessons",this.updateDetailFromLessons);this.listenTo(Ibles.Events,"courseProgress:markLessonInProgress",this.markLessonInProgress);this.listenTo(Ibles.Events,"courseProgress:markLessonComplete",this.markLessonComplete);this.updateDetailFromLessons()},updateDetailFromLessons:function(){_.each(this.get("lessons"),function(lesson){var lessonId=lesson.lessonId,existingDetail=this.details.get(lessonId);if(_.isEmpty(existingDetail)){this.details.add({id:lessonId})}},this)},markLessonInProgress:function(options){if(!_.isEmpty(options)&&!_.isEmpty(options.lessonId)){var existingDetail=this.details.get(options.lessonId);if(!_.isEmpty(existingDetail)&&!existingDetail.isInProgress()&&!existingDetail.isComplete()){existingDetail.set({status:"IN_PROGRESS"})}}},markLessonComplete:function(options){if(!_.isEmpty(options)&&!_.isEmpty(options.lessonId)){var existingDetail=this.details.get(options.lessonId);if(!_.isEmpty(existingDetail)&&!existingDetail.isComplete()){existingDetail.set({status:"COMPLETE"})}}},onDetailsChange:function(){var currentCourseProgressStatus=this.get("progressStatus"),nextCourseProgressStatus=this.getNextProgressStatus();if(currentCourseProgressStatus!=nextCourseProgressStatus){this.save()}},save:function(){var nextProgressStatus=this.getNextProgressStatus(),previouslyEnrolled=this.get("isEnrolled"),that=this;return this._super({objectId:this.get("courseId"),progressStatus:nextProgressStatus}).done(function(){that.set({isEnrolled:true,progressStatus:nextProgressStatus});if(!previouslyEnrolled){that.trigger("courseEnrollment")}})}});Ibles.package("Ibles.models");Ibles.models.CourseModel=Ibles.models.BaseInstructableModel.fullExtend({defaults:function(){return{id:null,courseId:null,urlString:null,title:null,square2Url:null,fullAccessFlag:false,studentAccess:false,studentAccessUntilDate:null,isEnrolled:null,difficulty:null,prerequisites:[],suggestedProjects:[],teacherBio:null,instructables:[],progressStatus:null,progressDetail:[],lessonsProgress:[]}},initialize:function(attributes,options){this._super(attributes,options);this.setProgressModel();this.setLessonsCollection();this.set({fullUrl:Ibles.pageContext.remoteHost+Ibles.reverseUrls.courseUrl(this.get("urlString"))});this.listenTo(this,"userDataSynced",this.afterUserDataSynced)},afterUserDataSynced:function(){this.setProgressModel()},setLessonsCollection:function(){this.lessons=new Ibles.collections.LessonCollection(this.get("instructables"))},setProgressModel:function(){if(_.isEmpty(this.progress))this.progress=new Ibles.models.CourseProgressModel;this.progress.set(_.extend(this.pick("courseId","isEnrolled","progressStatus","progressDetail","patch"),{lessons:this.get("instructables")}))},isEnrolledUser:function(){return this.get("isEnrolled")||this.progress.get("isEnrolled")},join:function(){return this.progress.save()},getUrl:function(){var urlString=this.get("urlString");if(_.isEmpty(urlString)&&this.get("url")){var url=this.get("url");urlString=url.substring(4,url.length-1)}return Ibles.reverseUrls.courseUrl(urlString||this.get("id"))},getLesson:function(lessonId){return this.lessons.get(lessonId)},getLessonByInstructableId:function(instructableId){return this.lessons.findWhere({id:instructableId})},getProgressStatusForLesson:function(lessonId){var lesson=this.getLesson(lessonId),progressDetail=this.progress.details.get(lessonId);return!_.isEmpty(progressDetail)?progressDetail.get("status"):null},isFullAccessCourse:function(){return this.get("fullAccessFlag")},userCanEnrollInCourse:function(){if(Ibles.session.authenticated()){return Ibles.session.isAdminOrPro()||this.get("studentAccess")||this.get("fullAccessFlag")}return false}});Ibles.package("Ibles.collections");Ibles.collections.CourseCollection=Backbone.Collection.extend({model:Ibles.models.CourseModel,fetch:function(){var self=this;return Ibles.API.getRequest("searchInstructables",{isCourse:"true",type:"guide"}).then(function(data){if(!_.isEmpty(data)&&!_.isEmpty(data.items)){self.reset(data.items)}})},fetchUserCourses:function(){var self=this;return Ibles.API.getRequest("getUserCourses").done(function(data){if(!_.isEmpty(data)&&!_.isEmpty(data.courses)){self.reset(data.courses)}})}});Ibles.package("Ibles.models");Ibles.models.ContainedLessonModel=Ibles.models.BaseInstructableModel.fullExtend({idAttribute:"lessonId",defaults:function(){return{id:null,lessonId:null,urlString:null,fullUrl:null,title:null,square2Url:null,fullAccessFlag:false,lessonDuration:null,projectDuration:null,isEnrolled:null}},initialize:function(attributes,options){this._super(attributes,options);this.setFullUrl()},setFullUrl:function(){this.set({fullUrl:Ibles.pageContext.remoteHost+Ibles.reverseUrls.lessonUrl(this.get("urlString")||this.get("id"))})},getUrl:function(){return Ibles.reverseUrls.lessonUrl(this.get("urlString")||this.get("id"))},isFullAccessLesson:function(){return this.get("fullAccessFlag")}});Ibles.models.LessonModel=Ibles.models.ContainedLessonModel.fullExtend({initialize:function(attributes,options){this._super(attributes,options);_.bindAll(this,"afterUserDataSynced");this.setProgressModel();this.setContainingCourse();this.afterUserDataSynced=_.after(2,this.afterUserDataSynced);this.listenTo(this,"userDataSynced",this.afterUserDataSynced);this.listenTo(this.containingCourse,"userDataSynced",this.afterUserDataSynced)},setProgressModel:function(){this.progress=new Ibles.models.LessonProgressModel},setContainingCourse:function(){this.containingCourse=new Ibles.models.CourseModel(_.extend({fetchUserData:this.get("fetchUserData")},this.get("containingCourse")))},afterUserDataSynced:function(){this.updateProgressModel();this.trigger("userDataSyncedForLessonAndContainingCourse")},updateProgressModel:function(){this.progress.set(this.pick("lessonId","isEnrolled","progressStatus","progressDetail"))},isFullAccessCourse:function(){return this.containingCourse.isFullAccessCourse()},isEnrolledUser:function(){return this.containingCourse.isEnrolledUser()},userCanEnrollInCourse:function(){return this.containingCourse.userCanEnrollInCourse()},userCanViewLesson:function(){return this.get("fullAccessFlag")||this.userCanEnrollInCourse()}});Ibles.package("Ibles.collections");Ibles.collections.LessonCollection=Backbone.Collection.extend({model:Ibles.models.ContainedLessonModel});window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["qa-view"]='<div class="qa-module qa-container">\n    <h2 class="title">Ask a Question</h2>\n    <div class="qa-question-search qa-search clearfix">\n        <div class="input-with-btn">\n            <input type="text" class="qa-question-search-input form-control" placeholder="Search existing questions..." />\n            <button class="btn btn-large btn-orange qa-search-btn" type="button"><i class="icon-search1"></i></button>\n        </div>\n    </div>\n    <div class="qa-question-inputs"></div>\n</div>';window.Ibles.JST["qa-question-list-view"]='<p class="qa-no-results-alert alert alert-error alert-danger hide-me">No results found</p>\n<ul class="qa-question-list list-unstyled clearfix">\n</ul>\n<div class="qa-show-more hide">More Questions<br/><i class="qa-show-more-icon icon-arrow-down"></i></div>';window.Ibles.JST["qa-question-view"]='<div class="qa-question-summary qa-question-header clearfix">\n    <span class="qa-question-title"><< title >></span>\n    <[ if (answered) {]><span class="qa-question-answered">Answered</span><[ } ]>\n    <span class="qa-spinner spinner"></span>\n    <span class="qa-question-meta">\n        <span class="qa-question-caret"> <img src="/intl_static/img/caret.png" /> </span>\n        <[ if (replyCount == 1) {]><< replyCount >> Answer<[ } else if (replyCount > 1) { ]><< replyCount >> Answers<[ }  ]>\n    </span>\n</div>';window.Ibles.JST["qa-question-detail-view"]='<div class="qa-post-item qa-question-post clearfix">\n    <a class="qa-author-avatar"><img class="qa-avatar-image" src="<< avatar >>"/></a>\n    <div class="qa-post-detail">\n        <div class="qa-post-header clearfix">\n            <p class="qa-author-byline">\n                Asked by <a class="qa-author-link" href="/member/<< author >>"><< author >></a> \n                <[ if (!_.isEmpty(lessonModel)) { ]>\n                    in <a class="qa-lesson-link" href="<< lessonModel.getUrl() >>"><< lessonModel.get(\'title\') >></a>\n                <[ } ]>\n            </p>\n            <a class="qa-answer-btn btn pro-required-course" data-sourcea="lesson:answerQuestion">Answer</a>\n        </div>        \n        <div class="qa-post-body"><< body >></div>\n        <ul class="qa-post-photos list-unstyled clearfix"></ul>\n        <div class="qa-admin-actions clearfix"></div>\n    </div>\n</div>\n\n<ul class="qa-answer-list list-unstyled clearfix">\n</ul>';window.Ibles.JST["qa-question-create-view"]='<div class="qa-create">\n    <p class="question-title-helper">\n        Give your question as descriptive a title as possible so others can easily find it. Max 70 characters.\n    </p>\n    <p class="input-holder"><input class="qa-question-title-input form-control" type="text" maxlength="70" placeholder="Question Title"/><span class="question-mark-prompt input-helper">?</span></p>\n    <div class="qa-question-body redactor-container">\n        <div class="redactor-tooltip" data-toggle="tooltip" data-placement="top" title="Highlight text to apply styling"></div>\n        <textarea class="redactor-textarea redactorAirComment qa-question-body-input box-sizer form-control" placeholder="Question Body: give us more detail on your question..."></textarea>\n        <div class="error-container hide-me"></div>\n    </div>\n    <div class="qa-image-bucket image-bucket clearfix"></div>\n    <div class="qa-question-action-bar action-bar clearfix">\n        <div class="action-bar-inner">\n            <a class="btn btn-lg qa-add-photos-btn pro-required-course" data-sourcea="class:qaAddPhoto" data-loading-text="<span class=\'orange-grey-spinner\'></span>">Add Photos</a>\n            <a class="btn btn-lg btn-orange qa-post-question-btn pro-required-course" data-sourcea="class:qaAskQuestion" data-loading-text="<span class=\'orange-grey-spinner\'></span>">Ask a Question</a>\n        </div>\n    </div>\n</div>';window.Ibles.JST["qa-answer-view"]='<div class="qa-post-item qa-answer-post clearfix">\n    <a class="qa-author-avatar"><img class="qa-avatar-image" src="<< avatar >>"/></a>\n    <div class="qa-post-detail">\n        <div class="qa-post-header clearfix">\n            <p class="qa-author-byline clearfix">\n                Reply by <a class="qa-author-link" href="/member/<< author >>"><< author >></a>\n                <span class="qa-best-answer <[ if (!bestAnswer){]>hide-me<[}]>">Best Answer</span>\n            </p>\n            <a class="qa-reply-btn btn pro-required-course" data-sourcea="lesson:replyToAnswer">Reply</a>\n        </div>\n        <div class="qa-post-body"><< body >></div>\n        <ul class="qa-post-photos list-unstyled clearfix"></ul>\n        <div class="qa-admin-actions clearfix"></div>\n    </div>\n</div>';window.Ibles.JST["qa-answer-create-view"]='<div class="qa-create qa-create-answer">\n    <div class="qa-answer-body redactor-container">\n        <div class="redactor-tooltip" data-toggle="tooltip" data-placement="top" title="Highlight text to apply styling"></div>\n        <textarea class="redactor-textarea redactorAirComment qa-answer-input box-sizer form-control" placeholder="Your answer..."></textarea>\n        <div class="error-container hide-me"></div>\n    </div>\n    <div class="qa-image-bucket image-bucket list-unstyled clearfix"></div>\n    <div class="action-bar clearfix">\n        <div class="action-bar-inner">\n            <a class="btn qa-add-photos-btn" data-loading-text="<span class=\'orange-grey-spinner\'></span>">Add Photos</a>            \n            <a class="btn btn-orange qa-post-answer-btn" data-loading-text="<span class=\'orange-grey-spinner\'></span>">Post Answer</a>\n        </div>\n        <div class="policy pull-left">\n            <img src="<< Ibles.staticUrl(\'img/instructable/comments/be-nice-en.png\') >>" />\n            <span>We have a be nice policy. Please be positive and constructive to your fellow students.</span>\n        </div>\n    </div>\n</div>';window.Ibles.JST["qa-image-file"]='<a class="qa-photo-link" rel="qa-thumb-<< file.collection.uuid >>" href="<< file.get(\'largeUrl\') >>" data-fancybox-href="/file/ << file.get(\'id\') >>" data-id="<< file.get(\'id\') >>">\n    <img class="photo fancybox-thumb" alt="Picture of << file.get(\'name\') >>" data-image-id="<< file.get(\'id\') >>" data-notes=\'<< file.get(\'imageNotes\') >>\' data-orig-height="<< file.get(\'height\') >>" data-orig-width="<< file.get(\'width\') >>" src="<< file.get(\'mediumUrl\') >>"/>\n</a>\n';window.Ibles.JST["qa-admin-actions"]='<a class="qa-admin-action qa-make-best hide-me" data-loading-text="<span class=\'orange-grey-spinner\'></span>">[best]</a>\n<a class="qa-admin-action qa-delete" data-loading-text="<span class=\'orange-grey-spinner\'></span>">[del]</a>\n<[ if (quarantine) { ]> <a class="qa-admin-action qa-unquarantine" data-loading-text="<span class=\'orange-grey-spinner\'></span>">[q-]</a> <[ } ]>\n<a class="qa-admin-action qa-limbo" data-loading-text="<span class=\'orange-grey-spinner\'></span>">[+l]</a>\n';Ibles.package("Ibles.views");Ibles.views.QACreateView=Backbone.View.extend({events:{"click .qa-add-photos-btn":"addPhotos"},lessonModel:null,courseModel:null,initialize:function(options){_.bindAll(this,"instantiateImageBucket");this.$el.html(this.template());var options=options||{};this.lessonModel=options.lessonModel,this.courseModel=options.courseModel;this.textSource=options.textSource;this.bucketSource=options.bucketSource;if(Ibles.isMobile())this.createMobileImageBucket();else this.createRedactorViewAndImageBucket()},addPhotos:function(e){if((this.lessonModel||this.courseModel).userCanEnrollInCourse()){e.preventDefault();this.imageBucket.addImages()}},createRedactorViewAndImageBucket:function(options){var opts=options||{},that=this;this.redactorView=new Ibles.views.RedactorTextAreaView({el:this.$(".redactor-container"),sourcea:this.textSource,redactorLoadedCallback:function(){that.instantiateImageBucket(".redactor_box")}})},createMobileImageBucket:function(){var that=this;this.instantiateImageBucket(".redactor-textarea");this.listenToOnce(this.imageBucket,"imagebucket:uploading",_.bind(function(){this.$(".qa-add-photos-btn").button("loading")},this));this.listenToOnce(this.imageBucket,"imagebucket:imageadded",_.bind(function(){this.$(".qa-add-photos-btn").button("reset")},this))},instantiateImageBucket:function(textarea){this.imageBucket=new Ibles.views.ImageBucketView({el:this.$(".image-bucket"),source:this.bucketSource,textarea:this.$(textarea),multiple:true})},validInputs:function(){var text=this.$(".redactor-textarea").val();return!_.isEmpty(text)&&text.indexOf("redactor_placeholder")===-1},showError:function(errorMessage){new Ibles.views.AlertLabelView({el:this.$(".error-container"),showClose:false,model:new Ibles.models.AlertModel({alertType:"error",alertMessage:errorMessage})})},hideError:function(){this.$(".error-container").hide()},reset:function(){this.imageBucket.destroy();if(Ibles.isMobile()){this.stopListening(this.imageBucket);this.createMobileImageBucket()}else{this.redactorView.reset()}}});Ibles.package("Ibles.models");Ibles.models.AnswerModel=Backbone.Model.extend({defaults:function(){return{id:null,questionId:null,body:null,publishDate:null,approved:null,author:null,authorId:null,avatar:null,status:null,deleted:null,sticky:null,quarantine:null,limbo:null,files:[],IMadeIt:null,inReplyTo:null,bestAnswer:false,limbo:false,quarantine:false,inReplyTo:null}},initialize:function(attributes,options){_.bindAll(this,"saveSuccess","saveError","saveComplete");this.files=new Ibles.collections.FileCollection(this.get("files"))},save:function(){this.trigger("savingAnswer");return Ibles.API.jsonPostRequest("addAnswer",this.getSaveParams()).done(this.saveSuccess).fail(this.saveError).always(this.saveComplete)},getSaveParams:function(){var params=this.pick("questionId","inReplyTo","title","body");if(_.isEmpty(params["inReplyTo"]))delete params["inReplyTo"];params.files=this.files.pluck("id");return params},saveSuccess:function(data){this.set(data);this.trigger("answerSaved")},saveError:function(data){},saveComplete:function(data){},makeBestAnswer:function(){return Ibles.API.jsonPostRequest("adminQuestion",{id:this.get("questionId"),bestAnswerId:this.get("id")}).done(_.bind(function(){var previousBest=this.collection.findWhere({bestAnswer:true});if(!_.isEmpty(previousBest)){previousBest.set({bestAnswer:false})}this.set({bestAnswer:true})},this))},deleteAnswer:function(){var self=this;return Ibles.API.postRequest("deleteComment",{id:this.get("id")},{success:function(data){self.collection.remove(self)}})},limboAnswer:function(){var params={action:"LIMBO",objectIds:this.get("id"),type:"C"},self=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){self.set({limbo:true})}})},unquarantineAnswer:function(){var params={action:"PUBLISH",objectIds:this.get("id"),type:"C"},self=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){self.set({quarantine:false,status:"PUBLISHED"})}})},shouldHideAnswer:function(){if(this.get("authorId")===Ibles.session.get("id")){return false}else if(this.get("status")==="PUBLISHED"){return false}else if(this.get("quarantine")&&Ibles.session.isAdmin()){return false}else{return true}}});Ibles.package("Ibles.collections");Ibles.collections.AnswerCollection=Backbone.Collection.extend({model:Ibles.models.AnswerModel,initialize:function(attributes,options){var opts=_.clone(options||{});this.questionId=opts.questionId},add:function(model,options){if(model)model.questionId=this.questionId;return Backbone.Collection.prototype.add.apply(this,arguments)},reset:function(answers){_.each(answers,function(answer){answer.questionId=this.questionId},this);return Backbone.Collection.prototype.reset.apply(this,arguments)},unshift:function(model){Backbone.Collection.prototype.unshift.apply(this,[model]);
this.trigger("answerPrepended",model)},insertAfter:function(after,model){var parentIndex=this.indexOf(this.get(after)),insertIndex=parentIndex+1;this.add(model,{index:insertIndex});this.trigger("answerInserted",model,insertIndex)}});Ibles.package("Ibles.views");Ibles.views.AnswerView=Backbone.View.extend({template:_.template(Ibles.JST["qa-answer-view"]),templateAdminActions:_.template(Ibles.JST["qa-admin-actions"]),className:"qa-answer-item",tagName:"li",events:{"click .qa-make-best":"saveAsBestAnswer","click .qa-delete":"deleteAnswer","click .qa-unquarantine":"unquarantineAnswer","click .qa-limbo":"limboAnswer","click .qa-reply-btn":"replyToAnswer"},initialize:function(options){this.answerModel=options.answerModel;this.lessonModel=options.lessonModel;this.courseModel=options.courseModel;this.render();this.listenTo(this.model,"change:bestAnswer",this.renderBestAnswer);this.listenTo(this.model,"remove",this.hide)},saveAsBestAnswer:function(e){e.preventDefault();var button=$(e.target);button.button("loading");this.model.makeBestAnswer().done(_.bind(function(){button.button("reset")},this))},render:function(){this.renderContainer();this.renderFiles();this.renderAdminActions();this.renderReplyCreateView();if(this.model.shouldHideAnswer()){this.$el.hide()}return this},renderContainer:function(){this.$el.html(this.template(this.model.toJSON()))},renderReplyCreateView:function(){this.replyCreateView=new Ibles.views.AnswerCreateView({model:this.answerModel,lessonModel:this.lessonModel,courseModel:this.courseModel,inReplyTo:this.model.get("id")});this.$(".qa-post-detail").append(this.replyCreateView.$el)},replyToAnswer:function(e){if((this.lessonModel||this.courseModel).userCanEnrollInCourse()){e.preventDefault();this.replyCreateView.$el.toggle();$("body,html").animate({scrollTop:this.replyCreateView.$el.offset().top-60},"slow")}},renderFiles:function(){var fileViews=_.map(this.model.files.models,function(model){return new Ibles.views.QAFileView({model:model})});Ibles.appendViews(fileViews,this.$(".qa-post-photos"));if(!Ibles.isMobile()){this.$(".qa-photo-link").fancybox()}else{this.$(".qa-photo-link").ibleLightbox({imageSize:"largeUrl",staticUrl:Ibles.pageContext.staticRoot,imageSet:_.map(this.model.files.models,function(file){return file.attributes}),navbarPosition:"top"})}},renderBestAnswer:function(){if(this.model.get("bestAnswer")){this.$(".qa-best-answer").show()}else{this.$(".qa-best-answer").hide()}},renderAdminActions:function(){if(Ibles.session.isAdmin()){this.$(".qa-admin-actions").html(this.templateAdminActions(this.model.toJSON()));this.$(".qa-make-best").show()}},hide:function(){this.$el.fadeOut(500)},deleteAnswer:function(e){if(confirm("Are you sure you want to delete this answer?")){this.adminActionFeedback(e,this.model.deleteAnswer())}},unquarantineAnswer:function(e){if(confirm("Are you sure you want to unquarantine this answer?")){this.adminActionFeedback(e,this.model.unquarantineAnswer())}},limboAnswer:function(e){if(confirm("Are you sure you want to limbo this answer?")){this.adminActionFeedback(e,this.model.limboAnswer())}},adminActionFeedback:function(e,promise){var target=$(e.target);target.button("loading");promise.always(function(){target.html("done")})}});Ibles.package("Ibles.views");Ibles.views.AnswerCreateView=Ibles.views.QACreateView.fullExtend({template:_.template(Ibles.JST["qa-answer-create-view"]),className:"qa-answer-create hide-me",model:null,lessonModel:null,courseModel:null,events:{"click .qa-post-answer-btn":"postAnswer"},initialize:function(options){this.textSource="qa-answer:textarea";this.bucketSource="qa-answer:imagebucket";this.inReplyTo=options.inReplyTo;this._super(options)},postAnswer:function(e){e.preventDefault();if(!this.validInputs()){this.showError("Answer required")}else{this.hideError();var model=this.createAnswerModel();$(e.target).button("loading");model.save().done(_.bind(function(){if(!_.isEmpty(this.inReplyTo)){this.model.answers.insertAfter(this.inReplyTo,model);this.$el.toggle()}else{this.model.answers.unshift(model);$("body,html").animate({scrollTop:this.$el.offset().top+100},"slow")}this.reset()},this))}},createAnswerModel:function(){var answer=new Ibles.models.AnswerModel({questionId:this.model.get("id"),author:Ibles.session.get("screenName"),authorId:Ibles.session.get("id"),avatar:Ibles.session.get("tinyUrl"),body:this.$(".redactor-textarea").val().replace(/\n/g,"<br>")});if(!_.isEmpty(this.inReplyTo)){answer.set({inReplyTo:this.inReplyTo})}answer.files.reset(this.imageBucket.getFiles().models);return answer},reset:function(){this._super();this.$(".qa-post-answer-btn").button("reset");this.$(".qa-answer-input").val("")}});Ibles.package("Ibles.models");Ibles.models.QuestionModel=Backbone.Model.extend({defaults:function(){return{id:null,guideId:null,instructableId:null,title:null,author:null,authorId:null,avatar:null,body:null,files:[],publishDate:null,lastCommentDate:null,answered:null,answers:[],bestAnswerId:null,status:null,replyCount:null,featureFlag:null,featureDate:null,limbo:false,quarantine:false}},initialize:function(attributes,options){_.bindAll(this,"fetchSuccess","fetchError","fetchComplete","saveSuccess","saveError","saveComplete");this.files=new Ibles.collections.FileCollection(this.get("files"));this.answers=new Ibles.collections.AnswerCollection(this.get("answers"),{questionId:this.get("id")});this.setBestAnswer();this.listenTo(this,"change:answers",this.resetAnswers);this.listenTo(this,"change:files",this.resetFiles)},resetAnswers:function(model,answers){this.answers.reset(answers);this.setBestAnswer()},resetFiles:function(model,files){this.files.reset(files)},setBestAnswer:function(){var bestAnswerId=this.get("bestAnswerId");if(!_.isEmpty(bestAnswerId)){var bestAnswerModel=this.answers.get(bestAnswerId);if(!_.isEmpty(bestAnswerModel)){bestAnswerModel.set({bestAnswer:true},{silent:true})}}},fetch:function(){this.trigger("fetchingQuestionDetail");return Ibles.API.getRequest("getQuestions",this.getFetchParams()).done(this.fetchSuccess).fail(this.fetchError).always(this.fetchComplete)},getFetchParams:function(){return{questionId:this.get("id")}},fetchSuccess:function(data){this.set(data.questions[0]);this.trigger("questionDetailAdded")},fetchError:function(data){},fetchComplete:function(data){},save:function(){this.trigger("savingQuestion");return Ibles.API.jsonPostRequest("newQuestion",this.getSaveParams()).done(this.saveSuccess).fail(this.saveError).always(this.saveComplete)},getSaveParams:function(){var keys=["title","body","instructableId","guideId"],that=this,params;keys=_.filter(keys,function(key){return!_.isNull(that.get(key))});params=this.pick(keys);params.files=this.files.pluck("id");if(_.isEmpty(params["instructableId"]))delete params["instructableId"];if(_.isEmpty(params["guideId"]))delete params["guideId"];return params},saveSuccess:function(data){this.set(data);this.trigger("questionSaved")},saveError:function(data){},saveComplete:function(data){},deleteQuestion:function(){return Ibles.API.jsonPostRequest("adminQuestion",{id:this.get("id"),"delete":"true"}).done(_.bind(function(){this.collection.remove(this)},this))},limboQuestion:function(){var params={action:"LIMBO",objectIds:this.get("id"),type:"Q"},self=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){self.set({limbo:true})}})},unquarantineQuestion:function(){var params={action:"PUBLISH",objectIds:this.get("id"),type:"Q"},self=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){self.set({quarantine:false,status:"PUBLISHED"})}})},toJSON:function(){var attrs=_.clone(this.attributes);attrs.publishDate=moment(attrs.publishDate).fromNow();return attrs}});Ibles.package("Ibles.collections");Ibles.collections.QuestionCollection=Backbone.Collection.extend({model:Ibles.models.QuestionModel,fetchOptions:["guideId","instructableId","limit","search","sort"],defaultFetchOptions:{limit:10,sort:"RECENT"},fullListSize:null,fullListOffset:null,listApiEndpoint:"listQuestions",initialize:function(models,options){_.bindAll(this,"fetchQuestionListSuccess","fetchQuestionDetailsSuccess","fetchError","fetchComplete");var opts=this.options=_.clone(options||{});this.setFetchParams(opts)},getFetchParams:function(){return this.fetchParams},setFetchParams:function(opts){var fetchParams=this.fetchParams||{};_.each(this.fetchOptions,function(option){if(!_.isEmpty(opts[option])){fetchParams[option]=opts[option]}},this);_.each(_.keys(this.defaultFetchOptions),function(option){if(_.isEmpty(fetchParams[option])){fetchParams[option]=this.defaultFetchOptions[option]}},this);this.fetchParams=fetchParams},fetch:function(){this.trigger("fetchingQuestions",_.clone(this.fetchParams));return Ibles.API.getRequest(this.listApiEndpoint,_.extend({offset:this.length},this.fetchParams)).done(this.fetchQuestionListSuccess).fail(this.fetchError)},fetchQuestionListSuccess:function(data){var questions=data.questions;this.fullListSize=data.fullListSize;this.fullListOffset=data.fullListOffset;if(questions.length){this.add(questions);if(this.options.fetchDetails){this.fetchQuestionDetails(questions)}else{this.triggerQuestionsAdded(questions)}}else if(this.models.length){this.trigger("noMoreQuestions")}else{this.trigger("noQuestions")}},fetchQuestionDetails:function(questions){var questionIds=_.reduce(questions,function(qs,question){return qs+(qs.length?"&":"")+"questionId="+question.id},""),self=this;$.ajax({url:"/json-api/getQuestions?"+questionIds,dataType:"json",type:"GET"}).done(this.fetchQuestionDetailsSuccess).fail(this.fetchError)},fetchQuestionDetailsSuccess:function(data){var questions=data.questions;this.add(questions,{merge:true});this.triggerQuestionsAdded(questions)},triggerQuestionsAdded:function(questions){this.trigger("questionsAdded",this.models.slice(this.length-questions.length),_.clone(this.fetchParams))},fetchError:function(data){},fetchComplete:function(data){},unshift:function(model){Backbone.Collection.prototype.unshift.apply(this,[model]);this.trigger("questionPrepended",model)}});Ibles.package("Ibles.views");Ibles.views.QuestionView=Backbone.View.extend({template:_.template(Ibles.JST["qa-question-view"]),className:"qa-question-item",tagName:"li",model:null,lessonModel:null,courseModel:null,events:{"click .qa-question-summary":"toggleQuestionDetails"},initialize:function(options){var opts=options||{};this.lessonModel=opts.lessonModel,this.courseModel=opts.courseModel;this.render();this.listenToOnce(this.model,"fetchingQuestionDetail",this.showSpinner);this.listenToOnce(this.model,"questionDetailAdded",this.hideSpinner);this.listenTo(this.model,"remove",this.hide)},toggleQuestionDetails:function(){if(!_.isEmpty(this.questionDetailView)){this.$el.toggleClass("expanded");this.questionDetailView.$el.slideToggle(400)}else{this.renderQuestionDetail()}},showSpinner:function(){this.$(".qa-spinner").show()},hideSpinner:function(){this.$(".qa-spinner").hide()},hide:function(){this.$el.fadeOut(500)},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.lessonModel){this.renderQuestionDetail()}return this},renderQuestionDetail:function(){if(_.isEmpty(this.questionDetailView)){this.questionDetailView=new Ibles.views.QuestionDetailView({model:this.model,lessonModel:this.lessonModel,courseModel:this.courseModel});this.$el.append(this.questionDetailView.$el);this.$el.addClass("expanded")}}});Ibles.package("Ibles.views");Ibles.views.QuestionDetailView=Backbone.View.extend({template:_.template(Ibles.JST["qa-question-detail-view"]),templateAdminActions:_.template(Ibles.JST["qa-admin-actions"]),className:"qa-question-detail hide-me",model:null,lessonModel:null,courseModel:null,events:{"click .qa-question-post .qa-answer-btn":"answerButtonClicked","click .qa-question-post .qa-delete":"deleteQuestion","click .qa-question-post .qa-unquarantine":"unquarantineQuestion","click .qa-question-post .qa-limbo":"limboQuestion"},initialize:function(options){var opts=options||{};this.lessonModel=opts.lessonModel,this.courseModel=opts.courseModel;if(this.lessonModel){this.render()}else{this.model.fetch();this.listenToOnce(this.model,"questionDetailAdded",this.render)}this.listenTo(this.model.answers,"answerPrepended",this.answerPrepended);this.listenTo(this.model.answers,"answerInserted",this.answerInserted)},answerButtonClicked:function(e){if((this.lessonModel||this.courseModel).userCanEnrollInCourse()){e.preventDefault();this.answerCreateView.$el.toggle();$("body,html").animate({scrollTop:this.answerCreateView.$el.offset().top-60},"slow")}},answerPrepended:function(model){var view=new Ibles.views.AnswerView({model:model,answerModel:this.model,lessonModel:this.lessonModel,courseModel:this.courseModel});view.$el.hide();this.$(".qa-answer-list").prepend(view.$el);view.$el.fadeIn(500)},answerInserted:function(model,insertIndex){var view=new Ibles.views.AnswerView({model:model,answerModel:this.model,lessonModel:this.lessonModel,courseModel:this.courseModel});view.$el.hide();$(this.$(".qa-answer-item")[insertIndex-1]).after(view.$el);view.$el.fadeIn(500)},render:function(){this.renderContainer();this.renderAdminActions();this.renderFiles();this.renderAnswerCreateView();this.renderAnswers()},renderContainer:function(){var json=this.model.toJSON(),lessonModel;if(this.courseModel){lessonModel=this.courseModel.getLessonByInstructableId(this.model.get("instructableId"))}_.extend(json,{lessonModel:lessonModel});this.$el.html(this.template(json));this.$el.show();return this},renderFiles:function(){var fileViews=_.map(this.model.files.models,function(model){return new Ibles.views.QAFileView({model:model})});Ibles.appendViews(fileViews,this.$(".qa-post-photos"));if(!Ibles.isMobile()){this.$(".qa-photo-link").fancybox()}else{this.$(".qa-photo-link").ibleLightbox({imageSize:"largeUrl",staticUrl:Ibles.pageContext.staticRoot,imageSet:_.map(this.model.files.models,function(file){return file.attributes}),navbarPosition:"top"})}},renderAnswerCreateView:function(){this.answerCreateView=new Ibles.views.AnswerCreateView({model:this.model,lessonModel:this.lessonModel,courseModel:this.courseModel});this.$(".qa-post-detail").append(this.answerCreateView.$el)},renderAnswers:function(){var that=this;var answerViews=_.map(this.model.answers.models,function(model){return new Ibles.views.AnswerView({model:model,answerModel:that.model,lessonModel:that.lessonModel,courseModel:that.courseModel})});Ibles.fadeInViews(answerViews,this.$(".qa-answer-list"))},renderAdminActions:function(){if(Ibles.session.isAdmin()){this.$(".qa-admin-actions").html(this.templateAdminActions(this.model.toJSON()))}},deleteQuestion:function(e){if(confirm("Are you sure you want to delete this question?")){this.adminActionFeedback(e,this.model.deleteQuestion())}},unquarantineQuestion:function(e){if(confirm("Are you sure you want to unquarantine this question?")){this.adminActionFeedback(e,this.model.unquarantineQuestion())}},limboQuestion:function(e){if(confirm("Are you sure you want to limbo this question?")){this.adminActionFeedback(e,this.model.limboQuestion())}},adminActionFeedback:function(e,promise){var target=$(e.target);target.button("loading");promise.always(function(){target.html("done")})}});Ibles.package("Ibles.views");Ibles.views.QuestionListView=Backbone.View.extend({template:_.template(Ibles.JST["qa-question-list-view"]),className:"qa-question-list-container hide-me",lessonModel:null,courseModel:null,events:{"click .qa-show-more":"showMoreQuestions"},initialize:function(options){var opts=options||{};this.lessonModel=opts.lessonModel,this.courseModel=opts.courseModel;this.showEmptyNotice=!!opts.showEmptyNotice;this.$el.html(this.template());this.listenTo(this.collection,"fetchingQuestions",this.fetchingQuestions);this.listenTo(this.collection,"questionsAdded",this.questionsAdded);this.listenTo(this.collection,"questionPrepended",this.questionPrepended);this.listenTo(this.collection,"noQuestions",this.renderNoResults);this.listenTo(this.collection,"reset",this.setRefreshFlag);if(this.collection.length){this.questionsAdded(this.collection.models,_.clone(this.collection.fetchParams))}},showMoreQuestions:function(e){e.preventDefault();this.collection.fetch()},fetchingQuestions:function(){this.$(".alert").hide()},setRefreshFlag:function(){this.refresh=true},questionPrepended:function(model){var view=new Ibles.views.QuestionView({model:model,lessonModel:this.lessonModel,courseModel:this.courseModel});view.$el.hide();this.$(".qa-question-list").prepend(view.$el);view.$el.fadeIn(500)},questionsAdded:function(models,fetchOptions){this.refreshINecessary();this.renderQuestions(models);this.renderShowMoreToggle(models,fetchOptions,this.collection.fullListSize)},renderNoResults:function(){this.refreshINecessary();if(this.showEmptyNotice&&!this.collection.length){this.$(".qa-no-results-alert").show()}},refreshINecessary:function(){if(this.refresh){this.$(".qa-question-list").empty();this.refresh=false}},renderQuestions:function(models){var questionViews=_.map(models,function(model){return new Ibles.views.QuestionView({model:model,lessonModel:this.lessonModel,courseModel:this.courseModel})},this);Ibles.fadeInViews(questionViews,this.$(".qa-question-list"))},renderShowMoreToggle:function(models,fetchOptions,fullListSize){if(models.length<fetchOptions.limit||this.collection.length==fullListSize){this.$(".qa-show-more").hide()}else{this.$(".qa-show-more").show().removeClass("hide")}}});Ibles.package("Ibles.views");Ibles.views.QuestionCreateView=Ibles.views.QACreateView.fullExtend({template:_.template(Ibles.JST["qa-question-create-view"]),className:"qa-question-create hide-me",lessonModel:null,courseModel:null,events:{"click .qa-post-question-btn":"postQuestion"},initialize:function(options){this.textSource="qa-question:textarea";this.bucketSource="qa-question:imagebucket";this._super(options)},postQuestion:function(e){if((this.lessonModel||this.courseModel).userCanEnrollInCourse()){e.preventDefault();if(!this.validInputs()){this.showError("Question title and body required")}else{this.hideError();var model=this.createQuestionModel();$(e.target).button("loading");model.save().done(_.bind(function(){this.collection.unshift(model);this.reset();$("body,html").animate({scrollTop:this.$el.offset().top+100},"slow")},this))}}},validInputs:function(){return!_.isEmpty(this.$(".qa-question-title-input").val())&&!_.isEmpty(this.$(".redactor-textarea").val())},createQuestionModel:function(){var question=new Ibles.models.QuestionModel({author:Ibles.session.get("screenName"),authorId:Ibles.session.get("id"),avatar:Ibles.session.get("tinyUrl"),publishDate:moment().fromNow(),title:this.$(".qa-question-title-input").val(),body:this.$(".redactor-textarea").val().replace(/\n/g,"<br>")});if(question.get("title").slice(-1)!="?"){question.set("title",question.get("title")+"?")}if(this.lessonModel){question.set({instructableId:this.lessonModel.get("id"),guideId:this.lessonModel.containingCourse.get("id")})}else if(this.courseModel){question.set({guideId:this.courseModel.get("id")})}question.files.reset(this.imageBucket.getFiles().models);return question},reset:function(){this._super();this.$(".qa-post-question-btn").button("reset");this.$(".qa-question-title-input").val("");this.$(".qa-question-body-input").val("")}});Ibles.package("Ibles.views");Ibles.views.QAFileListView=Backbone.View.extend({tagName:"ul",className:"qa-file-list",initialize:function(options){this.render()},render:function(){var fileViews=_.map(this.model.files.models,function(model){return new Ibles.views.QAFileView({model:model})});Ibles.appendViews(fileViews,this.$el);return this}});Ibles.package("Ibles.views");Ibles.views.QAFileView=Backbone.View.extend({template:_.template(Ibles.JST["qa-image-file"]),className:"qa-photo-item",tagName:"li",initialize:function(options){this.render()},render:function(){this.$el.html(this.template({file:this.model}));return this}});Ibles.package("Ibles.views");Ibles.views.QAView=Backbone.View.extend({template:_.template(Ibles.JST["qa-view"]),events:{"click .qa-search-btn":"searchButtonClicked","keyup .qa-question-search-input":"keyupOnSearchField","itemRemoved .qa-question-search-input":"clearSearchResultsList"},initialize:function(options){var collectionOptions={},options=options||{},lessonModel=options.lessonModel,courseModel=options.courseModel;if(courseModel){collectionOptions={guideId:courseModel.get("id"),fetchDetails:false}}else{collectionOptions={instructableId:lessonModel.get("id"),fetchDetails:true}}this.lessonModel=lessonModel;this.courseModel=courseModel;this.mainCollection=new Ibles.collections.QuestionCollection([],collectionOptions);this.searchCollection=new Ibles.collections.QuestionCollection([],collectionOptions);this.render()},searchButtonClicked:function(e){e.preventDefault();var searchTerm=this.getSearchTerm();if(!_.isEmpty(searchTerm)){this.executeSearch(searchTerm)}},toggleSearchTags:function(toggle){if(!toggle){this.$(".qa-question-search-input").tagsinput("destroy")}else{this.$(".qa-question-search-input").tagsinput({tagClass:"label big-label label-default",confirmKeys:[13],delimiterRegex:new RegExp(/\n/)});if(this.$(".big-label").outerWidth()>this.$(".bootstrap-tagsinput").outerWidth()){this.$(".big-label").addClass("long")}}},keyupOnSearchField:function(e){var searchTerm=this.getSearchTerm();if(_.isEmpty(searchTerm)){this.clearSearchResultsList()}else{if(e.which===13){this.executeSearch(searchTerm)}}},getSearchTerm:function(){return this.$(".qa-question-search-input").val()},executeSearch:function(searchTerm){this.searchCollection.reset();this.searchCollection.setFetchParams({search:searchTerm});this.searchCollection.fetch();this.showSearchResultsList()},render:function(){this.$el.html(this.template());this.appendQuestionCreateView();this.appendMainQuestionsList();this.appendSearchQuestionsList()},appendQuestionCreateView:function(){this.questionCreateView=new Ibles.views.QuestionCreateView({lessonModel:this.lessonModel,courseModel:this.courseModel,collection:this.mainCollection});this.$(".qa-question-inputs").append(this.questionCreateView.$el);this.questionCreateView.$el.show()},appendMainQuestionsList:function(){this.mainQuestions=new Ibles.views.QuestionListView({lessonModel:this.lessonModel,courseModel:this.courseModel,collection:this.mainCollection});this.$(".qa-container").append(this.mainQuestions.$el);this.mainQuestions.$el.show();this.mainCollection.fetch()},appendSearchQuestionsList:function(){this.searchQuestions=new Ibles.views.QuestionListView({lessonModel:this.lessonModel,courseModel:this.courseModel,collection:this.searchCollection,showEmptyNotice:true});this.$(".qa-container").append(this.searchQuestions.$el)},showSearchResultsList:function(){this.mainQuestions.$el.fadeOut(500,_.bind(function(){this.searchQuestions.$el.fadeIn(500);this.toggleSearchTags(true)},this))},clearSearchResultsList:function(){this.searchQuestions.$el.fadeOut(500,_.bind(function(){this.toggleSearchTags(false);this.mainQuestions.$el.fadeIn(500)},this))}});!function(a){"use strict";function b(b,c){this.itemsArray=[],this.$element=a(b),this.$element.hide(),this.isSelect="SELECT"===b.tagName,this.multiple=this.isSelect&&b.hasAttribute("multiple"),this.objectItems=c&&c.itemValue,this.placeholderText=b.hasAttribute("placeholder")?this.$element.attr("placeholder"):"",this.inputSize=Math.max(1,this.placeholderText.length),this.$container=a('<div class="bootstrap-tagsinput"></div>'),this.$input=a('<input type="text" placeholder="'+this.placeholderText+'"/>').appendTo(this.$container),this.$element.before(this.$container),this.build(c)}function c(a,b){if("function"!=typeof a[b]){var c=a[b];a[b]=function(a){return a[c]}}}function d(a,b){if("function"!=typeof a[b]){var c=a[b];a[b]=function(){return c}}}function e(a){return a?i.text(a).html():""}function f(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||"0"==a.selectionStart)&&(b=a.selectionStart);return b}function g(b,c){var d=!1;return a.each(c,function(a,c){if("number"==typeof c&&b.which===c)return d=!0,!1;if(b.which===c.which){var e=!c.hasOwnProperty("altKey")||b.altKey===c.altKey,f=!c.hasOwnProperty("shiftKey")||b.shiftKey===c.shiftKey,g=!c.hasOwnProperty("ctrlKey")||b.ctrlKey===c.ctrlKey;if(e&&f&&g)return d=!0,!1}}),d}var h={tagClass:function(a){return"label label-info"},itemValue:function(a){return a?a.toString():a},itemText:function(a){return this.itemValue(a)},itemTitle:function(a){return null},freeInput:!0,addOnBlur:!0,maxTags:void 0,maxChars:void 0,confirmKeys:[13,44],delimiter:",",delimiterRegex:null,cancelConfirmKeysOnEmpty:!0,onTagExists:function(a,b){b.hide().fadeIn()},trimValue:!1,allowDuplicates:!1};b.prototype={constructor:b,add:function(b,c,d){var f=this;if(!(f.options.maxTags&&f.itemsArray.length>=f.options.maxTags)&&(b===!1||b)){if("string"==typeof b&&f.options.trimValue&&(b=a.trim(b)),"object"==typeof b&&!f.objectItems)throw"Can't add objects when itemValue option is not set";if(!b.toString().match(/^\s*$/)){if(f.isSelect&&!f.multiple&&f.itemsArray.length>0&&f.remove(f.itemsArray[0]),"string"==typeof b&&"INPUT"===this.$element[0].tagName){var g=f.options.delimiterRegex?f.options.delimiterRegex:f.options.delimiter,h=b.split(g);if(h.length>1){for(var i=0;i<h.length;i++)this.add(h[i],!0);return void(c||f.pushVal())}}var j=f.options.itemValue(b),k=f.options.itemText(b),l=f.options.tagClass(b),m=f.options.itemTitle(b),n=a.grep(f.itemsArray,function(a){return f.options.itemValue(a)===j})[0];if(!n||f.options.allowDuplicates){if(!(f.items().toString().length+b.length+1>f.options.maxInputLength)){var o=a.Event("beforeItemAdd",{item:b,cancel:!1,options:d});if(f.$element.trigger(o),!o.cancel){f.itemsArray.push(b);var p=a('<span class="tag '+e(l)+(null!==m?'" title="'+m:"")+'">'+e(k)+'<span data-role="remove"></span></span>');if(p.data("item",b),f.findInputWrapper().before(p),p.after(" "),f.isSelect&&!a('option[value="'+encodeURIComponent(j)+'"]',f.$element)[0]){var q=a("<option selected>"+e(k)+"</option>");q.data("item",b),q.attr("value",j),f.$element.append(q)}c||f.pushVal(),(f.options.maxTags===f.itemsArray.length||f.items().toString().length===f.options.maxInputLength)&&f.$container.addClass("bootstrap-tagsinput-max"),f.$element.trigger(a.Event("itemAdded",{item:b,options:d}))}}}else if(f.options.onTagExists){var r=a(".tag",f.$container).filter(function(){return a(this).data("item")===n});f.options.onTagExists(b,r)}}}},remove:function(b,c,d){var e=this;if(e.objectItems&&(b="object"==typeof b?a.grep(e.itemsArray,function(a){return e.options.itemValue(a)==e.options.itemValue(b)}):a.grep(e.itemsArray,function(a){return e.options.itemValue(a)==b}),b=b[b.length-1]),b){var f=a.Event("beforeItemRemove",{item:b,cancel:!1,options:d});if(e.$element.trigger(f),f.cancel)return;a(".tag",e.$container).filter(function(){return a(this).data("item")===b}).remove(),a("option",e.$element).filter(function(){return a(this).data("item")===b}).remove(),-1!==a.inArray(b,e.itemsArray)&&e.itemsArray.splice(a.inArray(b,e.itemsArray),1)}c||e.pushVal(),e.options.maxTags>e.itemsArray.length&&e.$container.removeClass("bootstrap-tagsinput-max"),e.$element.trigger(a.Event("itemRemoved",{item:b,options:d}))},removeAll:function(){var b=this;for(a(".tag",b.$container).remove(),a("option",b.$element).remove();b.itemsArray.length>0;)b.itemsArray.pop();b.pushVal()},refresh:function(){var b=this;a(".tag",b.$container).each(function(){var c=a(this),d=c.data("item"),f=b.options.itemValue(d),g=b.options.itemText(d),h=b.options.tagClass(d);if(c.attr("class",null),c.addClass("tag "+e(h)),c.contents().filter(function(){return 3==this.nodeType})[0].nodeValue=e(g),b.isSelect){var i=a("option",b.$element).filter(function(){return a(this).data("item")===d});i.attr("value",f)}})},items:function(){return this.itemsArray},pushVal:function(){var b=this,c=a.map(b.items(),function(a){return b.options.itemValue(a).toString()});b.$element.val(c,!0).trigger("change")},build:function(b){var e=this;if(e.options=a.extend({},h,b),e.objectItems&&(e.options.freeInput=!1),c(e.options,"itemValue"),c(e.options,"itemText"),d(e.options,"tagClass"),e.options.typeahead){var i=e.options.typeahead||{};d(i,"source"),e.$input.typeahead(a.extend({},i,{source:function(b,c){function d(a){for(var b=[],d=0;d<a.length;d++){var g=e.options.itemText(a[d]);f[g]=a[d],b.push(g)}c(b)}this.map={};var f=this.map,g=i.source(b);a.isFunction(g.success)?g.success(d):a.isFunction(g.then)?g.then(d):a.when(g).then(d)},updater:function(a){return e.add(this.map[a]),this.map[a]},matcher:function(a){return-1!==a.toLowerCase().indexOf(this.query.trim().toLowerCase())},sorter:function(a){return a.sort()},highlighter:function(a){var b=new RegExp("("+this.query+")","gi");return a.replace(b,"<strong>$1</strong>")}}))}if(e.options.typeaheadjs){var j=null,k={},l=e.options.typeaheadjs;a.isArray(l)?(j=l[0],k=l[1]):k=l,e.$input.typeahead(j,k).on("typeahead:selected",a.proxy(function(a,b){k.valueKey?e.add(b[k.valueKey]):e.add(b),e.$input.typeahead("val","")},e))}e.$container.on("click",a.proxy(function(a){e.$element.attr("disabled")||e.$input.removeAttr("disabled"),e.$input.focus()},e)),e.options.addOnBlur&&e.options.freeInput&&e.$input.on("focusout",a.proxy(function(b){0===a(".typeahead, .twitter-typeahead",e.$container).length&&(e.add(e.$input.val()),e.$input.val(""))},e)),e.$container.on("keydown","input",a.proxy(function(b){var c=a(b.target),d=e.findInputWrapper();if(e.$element.attr("disabled"))return void e.$input.attr("disabled","disabled");switch(b.which){case 8:if(0===f(c[0])){var g=d.prev();g.length&&e.remove(g.data("item"))}break;case 46:if(0===f(c[0])){var h=d.next();h.length&&e.remove(h.data("item"))}break;case 37:var i=d.prev();0===c.val().length&&i[0]&&(i.before(d),c.focus());break;case 39:var j=d.next();0===c.val().length&&j[0]&&(j.after(d),c.focus())}var k=c.val().length;Math.ceil(k/5);c.attr("size",Math.max(this.inputSize,c.val().length))},e)),e.$container.on("keypress","input",a.proxy(function(b){var c=a(b.target);if(e.$element.attr("disabled"))return void e.$input.attr("disabled","disabled");var d=c.val(),f=e.options.maxChars&&d.length>=e.options.maxChars;e.options.freeInput&&(g(b,e.options.confirmKeys)||f)&&(0!==d.length&&(e.add(f?d.substr(0,e.options.maxChars):d),c.val("")),e.options.cancelConfirmKeysOnEmpty===!1&&b.preventDefault());var h=c.val().length;Math.ceil(h/5);c.attr("size",Math.max(this.inputSize,c.val().length))},e)),e.$container.on("click","[data-role=remove]",a.proxy(function(b){e.$element.attr("disabled")||e.remove(a(b.target).closest(".tag").data("item"))},e)),e.options.itemValue===h.itemValue&&("INPUT"===e.$element[0].tagName?e.add(e.$element.val()):a("option",e.$element).each(function(){e.add(a(this).attr("value"),!0)}))},destroy:function(){var a=this;a.$container.off("keypress","input"),a.$container.off("click","[role=remove]"),a.$container.remove(),a.$element.removeData("tagsinput"),a.$element.show()},focus:function(){this.$input.focus()},input:function(){return this.$input},findInputWrapper:function(){for(var b=this.$input[0],c=this.$container[0];b&&b.parentNode!==c;)b=b.parentNode;return a(b)}},a.fn.tagsinput=function(c,d,e){var f=[];return this.each(function(){var g=a(this).data("tagsinput");if(g)if(c||d){if(void 0!==g[c]){if(3===g[c].length&&void 0!==e)var h=g[c](d,null,e);else var h=g[c](d);void 0!==h&&f.push(h)}}else f.push(g);else g=new b(this,c),a(this).data("tagsinput",g),f.push(g),"SELECT"===this.tagName&&a("option",a(this)).attr("selected","selected"),a(this).val(a(this).val())}),"string"==typeof c?f.length>1?f:f[0]:f},a.fn.tagsinput.Constructor=b;var i=a("<div />");a(function(){a("input[data-role=tagsinput], select[multiple][data-role=tagsinput]").tagsinput()})}(window.jQuery);window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"
}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["quiz-view"]='<div class="quiz well">\n    <h4 class="header">QUIZ QUESTION << index >></h4>\n    <p class="question strong"><< question >></p>\n    <ul class="answer-list">\n    </ul>\n    <div class="notice">\n        <[ if (!completed) { ]>\n            <a class="btn btn-orange quiz-answer-btn pro-required-course" data-sourcea="lesson:quiz">Answer!</a>\n        <[ } ]>\n        <p class="success-container <[ if (!completed) { ]>hide-me<[ } ]>"><i class="icon icon-checkmark1"></i> <span class="success-notice"><< correctNotice >></span></p>\n        <p class="error-container hide-me"><i class="icon icon-delete2"></i> <span class="error-notice"><< incorrectNotice >></span></p>\n    </div>\n</div>';window.Ibles.JST["quiz-answer-view"]='<label class="checkbox">\n    <input type="checkbox" name="<< quizId >>" <[ if (selected) { ]>checked="true"<[ } ]>/> << title >>\n</label>';window.Ibles.JST["quiz-single-answer-view"]='<label class="radio">\n    <input type="radio" name="<< quizId >>" value="<< title >>" <[ if (selected) { ]>checked="true"<[ } ]>/> << title >>\n</label>';Ibles.package("Ibles.models");Ibles.models.QuizModel=Ibles.models.LessonProgressMarkerModel.fullExtend({defaults:function(){return{id:null,index:null,question:null,answers:[],correctNotice:"That's correct",incorrectNotice:"That's incoreect"}},initialize:function(attributes,options){this._super(attributes,options);this.setAnswersCollection();this.setCorrectAnswerModel()},setAnswersCollection:function(){var quizId=this.get("id"),answers=_.map(this.get("answers"),function(answer){answer.quizId=quizId;return answer},this);this.answers=new Ibles.collections.QuizAnswerCollection(answers)},setCorrectAnswerModel:function(){this.correctAnswers=this.answers.where({correct:true}).concat(this.answers.where({correct:"true"}));_.each(this.correctAnswers,function(correctAnswer){correctAnswer.set({selected:this.get("completed")})},this)},getProgressId:function(){return"quiz-"+this.get("id")},getSelectedAnswer:function(){return this.answers.getSelected()},correctAnswersSelected:function(){return this.answers.correctAnswersSelected()},unselectAnswers:function(){return this.answers.unselectAnswers()}});Ibles.package("Ibles.models");Ibles.models.QuizAnswerModel=Backbone.Model.extend({defaults:function(){return{quizId:null,title:null,correct:false,notice:null,selected:false}},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);if(_.isEmpty(json.notice))json.notice=json.correct?"That's correct!":"That's incorrect";return json}});Ibles.package("Ibles.collections");Ibles.collections.QuizAnswerCollection=Backbone.Collection.extend({model:Ibles.models.QuizAnswerModel,getSelected:function(){return this.where({selected:true})},correctAnswersSelected:function(){var selected=this.getSelected();if(_.isEmpty(selected))return false;return selected.every(function(model){var correct=model.get("correct");return correct===true||correct==="true"})},unselectAnswers:function(selected){_.each(selected.model.collection.models,function(model){if(model!=selected.model){model.set({selected:false})}})}});Ibles.package("Ibles.views");Ibles.views.QuizView=Backbone.View.extend({template:_.template(Ibles.JST["quiz-view"]),className:"quiz-module",model:null,lessonModel:null,events:{"click .quiz-answer-btn":"submitAnswer"},initialize:function(options){this.lessonModel=options&&options.lessonModel},submitAnswer:function(e){if(this.lessonModel.userCanEnrollInCourse()){e.preventDefault();if(this.model.correctAnswersSelected()){this.model.markCompleted();this.renderSuccess()}else{this.renderError()}}},renderSuccess:function(){this.$(".error-container").hide();this.$(".quiz-answer-btn").hide();this.$(".success-container").show()},renderError:function(){this.$(".success-container").hide();this.$(".error-container").show()},render:function(){this.renderQuestionContainer();this.renderAnswerChoices();return this},renderQuestionContainer:function(){this.$el.html(this.template(this.model.toJSON()))},renderAnswerChoices:function(){var correct=0;_.each(this.model.answers.models,function(answer){if(answer.get("correct")==true){correct+=1}});if(correct>1){var answerViews=_.map(this.model.answers.models,function(model){return new Ibles.views.QuizAnswerView({model:model,template:"quiz-answer-view"})})}else{var answerViews=_.map(this.model.answers.models,function(model){return new Ibles.views.QuizAnswerView({model:model,template:"quiz-single-answer-view"})})}Ibles.appendViews(answerViews,this.$(".answer-list"))}});Ibles.package("Ibles.views");Ibles.views.QuizAnswerView=Backbone.View.extend({template:null,className:"quiz-answer",tagName:"li",events:{click:"toggleSelection"},initialize:function(options){this.template=_.template(Ibles.JST[options.template]);this.render();this.listenTo(this.model,"change:selected",this.updateCheckedState)},toggleSelection:function(e){var inputType;if(e.target.nodeName!="INPUT"){e.preventDefault()}var model=this.model;model.set({selected:!model.get("selected")});if(e.target.nodeName=="LABEL"&&$(e.target).find("input").attr("type")=="radio"){inputType="radio"}else if(e.target.type=="RADIO"||e.target.type=="radio"){inputType="radio"}else{inputType="checkbox"}if(inputType=="radio"){this.model.collection.unselectAnswers(this)}},updateCheckedState:function(){this.$("input").prop("checked",this.model.get("selected"))},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["lesson-homework-complete"]='<div class="lesson-homework well well-large">\n    <h4 class="header">HOMEWORK</h4>\n    <p><i class="icon icon-checkmark1"></i> << actionCompletedMessage >></p>\n    <div class="image-container center">\n        <img src="<< imageUrl >>">\n    </div>\n    <button class="btn photo-delete-btn btn-orange" data-loading-text="Deleting...">Delete</button>\n</div>';window.Ibles.JST["lesson-homework-incomplete"]='<div class="lesson-homework well well-large">\n    <h4 class="header">HOMEWORK</h4>\n    <p><< actionMessage >></p>\n    <p>This is only visible to you.</p>\n    <button class="btn photo-upload-btn btn-orange pro-required-course" data-sourcea="lesson:homeworkUploadPhoto" data-loading-text="Uploading...">Upload Photo</button>\n</div>';Ibles.package("Ibles.models");Ibles.models.LessonHomeworkModel=Ibles.models.LessonProgressMarkerModel.fullExtend({defaults:function(){return{id:null,imageUrl:null,actionMessage:"Upload a photo of your progress to complete this lesson!",actionCompletedMessage:"Nice work! You've completed this homework"}},getProgressId:function(){return"homework-"+this.get("id")}});Ibles.package("Ibles.view");Ibles.views.LessonHomeworkView=Backbone.View.extend({templateIncomplete:_.template(Ibles.JST["lesson-homework-incomplete"]),templateComplete:_.template(Ibles.JST["lesson-homework-complete"]),className:"lesson-homework-module",model:null,lessonModel:null,events:{"click .photo-upload-btn":"uploadPhoto","click .photo-delete-btn":"deletePhoto"},initialize:function(options){this.lessonModel=options&&options.lessonModel;this.fileUploader=new Ibles.views.FileUploader({multiple:false});this.listenTo(this.fileUploader,"upload:start",this.uploadStarted);this.listenTo(this.fileUploader,"upload:success",this.uploadSucceeded);this.listenTo(this.model,"change:completed",this.render)},uploadPhoto:function(e){if(this.lessonModel.userCanEnrollInCourse()){e.preventDefault();this.fileUploader.showUploader()}},deletePhoto:function(e){if(this.lessonModel.userCanEnrollInCourse()){e.preventDefault();this.model.undoCompleted()}},uploadStarted:function(){this.$("button").button("loading")},uploadSucceeded:function(data){this.$("button").button("reset");this.model.markCompleted({imageUrl:data.square3Url})},render:function(){this.$el.html(this.getTemplate()(this.model.toJSON()));return this},getTemplate:function(){if(this.model.get("completed")){return this.templateComplete}else{return this.templateIncomplete}}});window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["image-bucket-image"]='<[ if (Ibles.isMobile()){ ]>\n<img src="<< tinyUrl >>" />\n<[ } else { ]>\n<img src="<< squareUrl >>" />\n<[ } ]>\n<div class="remove">&times;</div>';Ibles.package("Ibles.views");Ibles.views.ImageBucketView=Backbone.View.extend({multiple:false,initialize:function(options){_.bindAll(this,"showUploader","hideIfEmpty");var that=this;options=options||{};this.itemViewConstructor=options.itemViewConstructor||Ibles.views.ImageBucketImageView;this.multiple=!!options.multiple;this.prepend=!!options.prepend;this.textarea=options.textarea;this.directUpload=!!options.directUpload||Ibles.isMobile();if(this.directUpload){head.load(Ibles.assets.mobileUploader())}if(_.isEmpty(this.collection))this.collection=new Ibles.collections.FileCollection([]);if(this.collection.length>0){this.collection.each(function(model){that.renderModel(model)})}},addImages:function(){this.showUploader()},getFiles:function(){return new Ibles.collections.FileCollection(this.collection.models)},showUploader:function(){var self=this;if(this.directUpload){this.showMobileUploader()}else{Ibles.fetchUploader(function(){self.showDesktopUploader()})}},showMobileUploader:function(){this.stopListening();this.uploader=new Ibles.views.FileUploader({multiple:this.multiple});this.listenToOnce(this.uploader,"upload:start",_.bind(function(){this.trigger("imagebucket:uploading")},this));this.listenTo(this.uploader,"upload:success",_.bind(function(data){this.uploadSuccess(_.clone(data));this.trigger("imagebucket:imageadded",_.clone(data))},this));this.listenToOnce(this.uploader,"upload:complete",_.bind(function(){this.trigger("imagebucket:uploadcomplete")},this));this.listenToOnce(this.uploader,"upload:error",_.bind(function(){this.trigger("imagebucket:uploaderror")},this));this.uploader.showUploader()},showDesktopUploader:function(){this.stopListening();var uploaderCollection=new ibles.FileSet;this.listenTo(uploaderCollection,"add",_.bind(function(model){this.uploadSuccess(_.clone(model.attributes));this.trigger("imagebucket:imageadded",_.clone(model.attributes))},this));this.uploader=new window.ibles.uploadModalView({collection:uploaderCollection})},uploadSuccess:function(data){var fileModel=new Ibles.models.FileModel(data);this.renderModel(fileModel)},renderModel:function(fileModel){var imageView=new this.itemViewConstructor({model:fileModel});if(!this.prepend){this.collection.add(fileModel);this.$el.append(imageView.render().$el)}else{this.collection.add(fileModel,{at:0});this.$el.prepend(imageView.render().$el)}this.listenToOnce(fileModel,"remove",this.hideIfEmpty);if(!_.isEmpty(this.textarea)){this.textarea.addClass("has-images")}this.$el.show()},hideIfEmpty:function(model){_.delay($.proxy(function(){if(this.collection.length===0){this.$el.hide();if(!_.isEmpty(this.textarea)){this.textarea.removeClass("has-images")}}},this))},destroy:function(){this.undelegateEvents();if(!_.isEmpty(this.textarea))this.textarea.removeClass("has-images");this.$el.hide();this.$el.empty();this.stopListening();this.collection.off(null,null,this);this.collection.reset()}});Ibles.package("Ibles.views");Ibles.views.ImageBucketImageView=Backbone.View.extend({template:_.template(Ibles.JST["image-bucket-image"]),className:"bucket-image",events:{"click .remove":"remove"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},remove:function(){this.model.collection.remove(this.model);this.$el.remove()}});window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["course-complete-modal"]='\n<[ if (Ibles.isMobile()) { ]>\n<div class="modal-dialog">\n    <div class="modal-content">\n<[ } ]>\n        <div class="modal-body">\n            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n            <div class="course-badge">\n                <img src="<< patch.square2Url >>"/>\n            </div>\n            <h3>Congratulations!</h3>\n            <p>You have completed the class and earned your badge!</p>\n            <p>Ready to use your new skills to make something awesome?</p>\n            <[ url = Ibles.reverseUrls.ibleUrl(suggestedProjects.urlString) ]>\n            <a href="<< url >>" class="btn btn-large btn-lg projects-link"> Find Projects &raquo; </a>\n        </div>\n<[ if (Ibles.isMobile()) { ]>\n    </div>\n</div>\n<[ } ]>';Ibles.package("Ibles.views");Ibles.views.CourseCompletedModal=Backbone.View.extend({className:"modal fade finished-modal",template:_.template(Ibles.JST["course-complete-modal"]),initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.appendTo($("body"));this.$el.modal("show")}});window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["course-enrollment-modal"]='<div class="modal fade enrollment-modal">\n<[ if (Ibles.isMobile()) { ]>\n<div class="modal-dialog">\n    <div class="modal-content">\n<[ } ]>\n        <div class="modal-body">\n            <button type="button" class="close" data-dismiss="modal">&times;</button>\n            <div class="robot">\n                <img src="/intl_static/img/graduation-robot.png"/>\n            </div>\n                <p class="bold">\n                    Congrats on enrolling!\n                </p>\n                <p class="message">You have three months of free access to complete the class. We\'re here to help if you have any questions.</p>\n                <div class="btn btn-default close-modal" data-dismiss="modal">Got it, Thanks!</div>\n        </div>\n<[ if (Ibles.isMobile()) { ]>\n    </div>\n</div>\n<[ } ]>\n</div>';Ibles.package("Ibles.views");Ibles.views.RedactorTextAreaView=Backbone.View.extend({initialize:function(options){_.bindAll(this,"redactorLoaded","sync");options=options||{};this.enableHtml=options.enableHtml||false;this.textArea=this.$(".redactor-textarea");this.toolTip=this.$(".redactor-tooltip");this.redactorOptions=options.redactorOptions||{};if(this.enableHtml){this.addHtmlOptions()}this.redactorLoadedCallback=options.redactorLoadedCallback;this.addRedactorAirMode()},addHtmlOptions:function(){var adminOptions={airButtons:["bold","italic","heading","link_ibles","quote","html"],convertDivs:false,deniedTags:[],syncBeforeCallback:function(html){if(this.editedCode===true){return this.get()}return html},textareaKeydownCallback:function(e){this.editedCode=true},keydownCallback:function(e){this.editedCode=false}};this.redactorOptions=_.extend(this.redactorOptions,adminOptions)},addRedactorAirMode:function(){var self=this;head.load("/static/drag_editor/dependencies/redactorInstructables/redactor_air_instructables.6.js",function(){loadRedactorAir(self.textArea,{redactorOptions:self.redactorOptions,callback:self.redactorLoaded})})},redactorLoaded:function(){this.trigger("redactorLoaded");if(typeof this.redactorLoadedCallback==="function"){this.redactorLoadedCallback()}},sync:function(){this.textArea.redactor("sync");return this.textArea.redactor("get")},hideToolTip:function(){this.toolTip.tooltip("hide");this.$(".redactor_redactor-textarea").off("click")},reset:function(){this.$(".redactor_editor").empty();this.textArea.val("")}});Ibles.package("Ibles.views");Ibles.views.FileUploader=Backbone.View.extend({defaults:{multiple:false,uploadField:null,validFileTypes:[],singleFileUploads:true,sequentialUploads:true,replaceFileInput:false,imageOrientation:true,disableImageResize:false,imageMaxWidth:null,imageMaxHeight:null,imageMinWidth:null,imageMaxWidth:null},initialize:function(options){var options=this.options=_.extend({},this.defaults,options||{});this.enableUploader()},showUploader:function(){this.uploadField.click()},isValidFiles:function(files,validFileTypes){return _.every(files,function(file){var ext=file.name.split(".").pop().toLowerCase();return _.contains(validFileTypes,ext)})},getUploadField:function(){var options=this.options,uploadField=null;if(options.uploadField){uploadField=options.uploadField}else{if(options.multiple){uploadField=$('<input type="file" name="files[]" multiple>')}else{uploadField=$('<input type="file" name="files[]">')}}return uploadField},enableUploader:function(){var self=this,options=this.options,uploadedFileCount=0;head.load(Ibles.assets.mobileUploader(),function(){self.uploadField=self.getUploadField();self.uploadWidget=self.uploadField.fileupload(_.extend({url:"//"+window.location.host+"/json-api/upload"},options)).on("fileuploadchange",function(e,data){self.hasInvalidFiles=false;if(!_.isEmpty(options.validFileTypes)){if(!self.isValidFiles(data.files,options.validFileTypes)){self.hasInvalidFiles=true;self.trigger("upload:invalid",data)}}}).on("fileuploadadd",function(e,data){if(self.hasInvalidFiles)e.preventDefault()}).on("fileuploaddone",function(e,data){var result=data.result;if($.isArray(result.loaded)){self.trigger("upload:success",result.loaded[0])}else{self.trigger("upload:error",data)}}).on("fileuploadsubmit",function(e,data){self.trigger("upload:start",data)}).on("fileuploadalways",function(e,data){uploadedFileCount++;if(data.originalFiles.length===uploadedFileCount){self.trigger("upload:complete")}}).on("fileuploadfail",function(e,data){self.trigger("upload:error",data)})})}});Ibles.package("Ibles.views");Ibles.views.BaseInstructableView=Backbone.View.extend({events:{"click .download-pdf":"showDownloadPdfPage"},initialize:function(opts){this.opts=_.clone(opts||{});this.setUpCategoryTracking();this.setupGtmDataLayer()},showDownloadPdfPage:function(e){if(Ibles.session.isAdminProOrOld()){e.preventDefault();window.location=this.$(".download-pdf").data("return-url")}},attemptFave:function(e){if(Ibles.session.authenticated()){e.preventDefault();Ibles.alertWhenError(this.model.favoriteAction())}},attemptFollow:function(e){if(Ibles.session.authenticated()){e.preventDefault();Ibles.alertWhenError(this.model.author.toggleFollowing())}},shareOnGPlus:function(e){e.preventDefault();window.open($(e.currentTarget).attr("href"),"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600");return false},shareOnFacebook:function(e){if(!_.isUndefined(FB)){e.preventDefault();FB.ui({method:"share",href:this.model.get("fullUrl")})}},setupSyntaxHighlighting:function(){var promises=[];$("pre").each(function(idx,el){if($(el).attr("data-src")&&$(el).attr("data-src")!=""){var promise=$.ajax({url:$(el).attr("data-src"),type:"GET",success:function(d){$(el).append($("<code></code>").text(d))}});promises.push(promise)}});if(promises.length>0){$("head").append('<link rel="stylesheet" href="/intl_static/css/prism/prism.css" type="text/css" />');$.when.apply($,promises).always(function(){sessionReady(["/intl_static/js/prism/prism.js"],function(){Prism.highlightAll(true)})})}},setUpCategoryTracking:function(){var categoryCounts={},channelCounts={},category=this.model.get("category"),channel=this.model.get("channel");if(_.isUndefined($.cookie("categoryTimer"))){var expiry=moment().add(30,"m"),path=Ibles.reverseUrls.ibleUrl(this.model.get("urlString"));$.cookie("categoryTimer",this.model.get("id"),{path:path,expires:expiry.toDate()});try{if(!_.isUndefined(localStorage["ibleCategories"])){categoryCounts=JSON.parse(localStorage["ibleCategories"])}if(_.isUndefined(categoryCounts[category])){categoryCounts[category]=1}else{categoryCounts[category]=categoryCounts[category]+1}localStorage["ibleCategories"]=JSON.stringify(categoryCounts);if(!_.isUndefined(channel)){if(!_.isUndefined(localStorage["ibleChannels"])){channelCounts=JSON.parse(localStorage["ibleChannels"])}if(_.isUndefined(channelCounts[channel])){channelCounts[channel]=1}else{channelCounts[channel]=channelCounts[channel]+1}localStorage["ibleChannels"]=JSON.stringify(channelCounts)}}catch(e){try{localStorage.clear()}catch(clearError){}}}},setupGtmDataLayer:function(){if(window.dataLayer){window.dataLayer.push(this.model.attributes)}}});!function($){window.Ibles=window.Ibles||{};window.Ibles=_.extend(window.Ibles,{showCourseGoproSignupModal:function(options){var options=options||{};Ibles.showSignupModal(_.extend(options,{template:_.template(Ibles.JST[Ibles.isMobile()?"course-gopro-signup-modal-mobile":"course-gopro-signup-modal"]),roles:"admin,pro",paymentPlan:Ibles.pageContext.paymentPlans.course,returnUrl:Ibles.getCurrentUrl()}))},showCourseGoproModal:function(options){var options=options||{};Ibles.showGoproModal(_.extend(options,{template:_.template(Ibles.JST[Ibles.isMobile()?"course-gopro-modal-mobile":"course-gopro-modal"]),roles:"admin,pro",paymentPlan:Ibles.pageContext.paymentPlans.course,returnUrl:Ibles.getCurrentUrl()}))},showCourseEnrollmentModal:function(reload){var options={template:_.template(Ibles.JST["course-enrollment-modal"])},modal;if(reload===true){options["onClose"]=function(){window.location.reload(true)}}modal=new Ibles.views.BaseModalView(options);modal.render()}})}(jQuery);!function(t,m,e){var l=e(t),q=e(m),a=e.fancybox=function(){a.open.apply(this,arguments)},r=!1,s="undefined"!==typeof m.createTouch;e.extend(a,{version:"2.0.5",defaults:{padding:15,margin:20,width:800,height:600,minWidth:100,minHeight:100,maxWidth:9999,maxHeight:9999,autoSize:!0,autoResize:!s,autoCenter:!s,fitToView:!0,aspectRatio:!1,topRatio:.5,fixed:!(e.browser.msie&&6>=e.browser.version)&&!s,scrolling:"auto",wrapCSS:"fancybox-default",arrows:!0,closeBtn:!0,closeClick:!1,nextClick:!1,mouseWheel:!0,autoPlay:!1,playSpeed:3e3,preload:3,modal:!1,loop:!0,ajax:{dataType:"html",headers:{"X-fancyBox":!0}},keys:{next:[13,32,34,39,40],prev:[8,33,37,38],close:[27]},tpl:{wrap:'<div class="fancybox-wrap"><div class="fancybox-outer"><div class="fancybox-inner"></div></div></div>',image:'<img class="fancybox-image" src="{href}" alt="" />',iframe:'<iframe class="fancybox-iframe" name="fancybox-frame{rnd}" frameborder="0" hspace="0"'+(e.browser.msie?' allowtransparency="true"':"")+"></iframe>",swf:'<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%"><param name="wmode" value="transparent" /><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="movie" value="{href}" /><embed src="{href}" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="100%" height="100%" wmode="transparent"></embed></object>',error:'<p class="fancybox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn:'<div title="Close" class="fancybox-item fancybox-close"></div>',next:'<a title="Next" class="fancybox-nav fancybox-next"><span></span></a>',prev:'<a title="Previous" class="fancybox-nav fancybox-prev"><span></span></a>'},openEffect:"fade",openSpeed:250,openEasing:"swing",openOpacity:!0,openMethod:"zoomIn",closeEffect:"fade",closeSpeed:250,closeEasing:"swing",closeOpacity:!0,closeMethod:"zoomOut",nextEffect:"elastic",nextSpeed:300,nextEasing:"swing",nextMethod:"changeIn",prevEffect:"elastic",prevSpeed:300,prevEasing:"swing",prevMethod:"changeOut",helpers:{overlay:{speedIn:0,speedOut:300,opacity:.8,css:{cursor:"pointer"},closeClick:!0},title:{type:"float"}}},group:{},opts:{},coming:null,current:null,isOpen:!1,isOpened:!1,wrap:null,outer:null,inner:null,player:{timer:null,isActive:!1},ajaxLoad:null,imgPreload:null,transitions:{},helpers:{},open:function(b,c){a.close(!0);b&&!e.isArray(b)&&(b=b instanceof e?e(b).get():[b]);a.isActive=!0;a.opts=e.extend(!0,{},a.defaults,c);e.isPlainObject(c)&&"undefined"!==typeof c.keys&&(a.opts.keys=c.keys?e.extend({},a.defaults.keys,c.keys):!1);a.group=b;a._start(a.opts.index||0)},cancel:function(){a.coming&&!1===a.trigger("onCancel")||(a.coming=null,a.hideLoading(),a.ajaxLoad&&a.ajaxLoad.abort(),a.ajaxLoad=null,a.imgPreload&&(a.imgPreload.onload=a.imgPreload.onabort=a.imgPreload.onerror=null))},close:function(b){a.cancel();a.current&&!1!==a.trigger("beforeClose")&&(a.unbindEvents(),!a.isOpen||b&&!0===b[0]?(e(".fancybox-wrap").stop().trigger("onReset").remove(),a._afterZoomOut()):(a.isOpen=a.isOpened=!1,e(".fancybox-item, .fancybox-nav").remove(),a.wrap.stop(!0).removeClass("fancybox-opened"),a.inner.css("overflow","hidden"),a.transitions[a.current.closeMethod]()))},play:function(b){var c=function(){clearTimeout(a.player.timer)},d=function(){c();a.current&&a.player.isActive&&(a.player.timer=setTimeout(a.next,a.current.playSpeed))},g=function(){c();e("body").unbind(".player");a.player.isActive=!1;a.trigger("onPlayEnd")};if(a.player.isActive||b&&!1===b[0])g();else if(a.current&&(a.current.loop||a.current.index<a.group.length-1))a.player.isActive=!0,e("body").bind({"afterShow.player onUpdate.player":d,"onCancel.player beforeClose.player":g,"beforeLoad.player":c}),d(),a.trigger("onPlayStart")},next:function(){a.current&&a.jumpto(a.current.index+1)},prev:function(){a.current&&a.jumpto(a.current.index-1)},jumpto:function(b){a.current&&(b=parseInt(b,10),1<a.group.length&&a.current.loop&&(b>=a.group.length?b=0:0>b&&(b=a.group.length-1)),"undefined"!==typeof a.group[b]&&(a.cancel(),a._start(b)))},reposition:function(b){a.isOpen&&a.wrap.css(a._getPosition(b))},update:function(b){a.isOpen&&(r||setTimeout(function(){var c=a.current;if(r&&(r=!1,c)){if(c.autoResize||b&&"orientationchange"===b.type)c.autoSize&&(a.inner.height("auto"),c.height=a.inner.height()),a._setDimension(),c.canGrow&&a.inner.height("auto");c.autoCenter&&a.reposition();a.trigger("onUpdate")}},100),r=!0)},toggle:function(){a.isOpen&&(a.current.fitToView=!a.current.fitToView,a.update())},hideLoading:function(){e("#fancybox-loading").remove()},showLoading:function(){a.hideLoading();e('<div id="fancybox-loading"><div></div></div>').click(a.cancel).appendTo("body")},getViewport:function(){return{x:l.scrollLeft(),y:l.scrollTop(),w:l.width(),h:l.height()}},unbindEvents:function(){a.wrap&&a.wrap.unbind(".fb");q.unbind(".fb");l.unbind(".fb")},bindEvents:function(){var b=a.current,c=b.keys;b&&(l.bind("resize.fb, orientationchange.fb",a.update),c&&q.bind("keydown.fb",function(b){var g;!b.ctrlKey&&!b.altKey&&!b.shiftKey&&!b.metaKey&&0>e.inArray(b.target.tagName.toLowerCase(),["input","textarea","select","button"])&&(g=b.keyCode,-1<e.inArray(g,c.close)?(a.close(),b.preventDefault()):-1<e.inArray(g,c.next)?(a.next(),b.preventDefault()):-1<e.inArray(g,c.prev)&&(a.prev(),b.preventDefault()))}),e.fn.mousewheel&&b.mouseWheel&&1<a.group.length&&a.wrap.bind("mousewheel.fb",function(b,c){var f=e(b.target).get(0);if(0===f.clientHeight||f.scrollHeight===f.clientHeight&&f.scrollWidth===f.clientWidth)b.preventDefault(),a[0<c?"prev":"next"]()}))},trigger:function(b){var c,d=a[-1<e.inArray(b,["onCancel","beforeLoad","afterLoad"])?"coming":"current"];if(d){e.isFunction(d[b])&&(c=d[b].apply(d,Array.prototype.slice.call(arguments,1)));if(!1===c)return!1;d.helpers&&e.each(d.helpers,function(c,f){if(f&&"undefined"!==typeof a.helpers[c]&&e.isFunction(a.helpers[c][b]))a.helpers[c][b](f,d)});e.event.trigger(b+".fb")}},isImage:function(a){return a&&a.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i)},isSWF:function(a){return a&&a.match(/\.(swf)(.*)?$/i)},_start:function(b){var c={},d=a.group[b]||null,g,f,k;if(d&&(d.nodeType||d instanceof e))g=!0,e.metadata&&(c=e(d).metadata());c=e.extend(!0,{},a.opts,{index:b,element:d},e.isPlainObject(d)?d:c);e.each(["href","title","content","type"],function(b,f){c[f]=a.opts[f]||g&&e(d).attr(f)||c[f]||null});"number"===typeof c.margin&&(c.margin=[c.margin,c.margin,c.margin,c.margin]);c.modal&&e.extend(!0,c,{closeBtn:!1,closeClick:!1,nextClick:!1,arrows:!1,mouseWheel:!1,keys:null,helpers:{overlay:{css:{cursor:"auto"},closeClick:!1}}});a.coming=c;if(!1===a.trigger("beforeLoad"))a.coming=null;else{f=c.type;b=c.href||d;f||(g&&(k=e(d).data("fancybox-type"),!k&&d.className&&(f=(k=d.className.match(/fancybox\.(\w+)/))?k[1]:null)),!f&&"string"===e.type(b)&&(a.isImage(b)?f="image":a.isSWF(b)?f="swf":b.match(/^#/)&&(f="inline")),f||(f=g?"inline":"html"),c.type=f);if("inline"===f||"html"===f){if(c.content||(c.content="inline"===f?e("string"===e.type(b)?b.replace(/.*(?=#[^\s]+$)/,""):b):d),!c.content||!c.content.length)f=null}else b||(f=null);c.group=a.group;c.isDom=g;c.href=b;"image"===f?a._loadImage():"ajax"===f?a._loadAjax():f?a._afterLoad():a._error("type")}},_error:function(b){a.hideLoading();e.extend(a.coming,{type:"html",autoSize:!0,minHeight:0,hasError:b,content:a.coming.tpl.error});a._afterLoad()},_loadImage:function(){a.imgPreload=new Image;a.imgPreload.onload=function(){this.onload=this.onerror=null;a.coming.width=this.width;a.coming.height=this.height;a._afterLoad()};a.imgPreload.onerror=function(){this.onload=this.onerror=null;a._error("image")};a.imgPreload.src=a.coming.href;a.imgPreload.width||a.showLoading()},_loadAjax:function(){a.showLoading();a.ajaxLoad=e.ajax(e.extend({},a.coming.ajax,{url:a.coming.href,error:function(b,c){"abort"!==c?a._error("ajax",b):a.hideLoading()},success:function(b,c){"success"===c&&(a.coming.content=b,a._afterLoad())}}))},_preloadImages:function(){var b=a.group,c=a.current,d=b.length,g;if(c.preload&&!(2>b.length))for(var f=1;f<=Math.min(c.preload,d-1);f++)if(g=b[(c.index+f)%d],g=e(g).attr("href")||g)(new Image).src=g},_afterLoad:function(){a.hideLoading();!a.coming||!1===a.trigger("afterLoad",a.current)?a.coming=!1:(a.isOpened?(e(".fancybox-item").remove(),a.wrap.stop(!0).removeClass("fancybox-opened"),a.inner.css("overflow","hidden"),a.transitions[a.current.prevMethod]()):(e(".fancybox-wrap").stop().trigger("onReset").remove(),a.trigger("afterClose")),a.unbindEvents(),a.isOpen=!1,a.current=a.coming,a.wrap=e(a.current.tpl.wrap).addClass("fancybox-"+(s?"mobile":"desktop")+" fancybox-tmp "+a.current.wrapCSS).appendTo("body"),a.outer=e(".fancybox-outer",a.wrap).css("padding",a.current.padding+"px"),a.inner=e(".fancybox-inner",a.wrap),a._setContent())},_setContent:function(){var b,c,d=a.current,g=d.type;switch(g){case"inline":case"ajax":case"html":b=d.content;
b instanceof e&&(b=b.show().detach(),b.parent().hasClass("fancybox-inner")&&b.parents(".fancybox-wrap").trigger("onReset").remove(),e(a.wrap).bind("onReset",function(){b.appendTo("body").hide()}));d.autoSize&&(c=e('<div class="fancybox-tmp '+a.current.wrapCSS+'"></div>').appendTo("body").append(b),d.width=c.width(),d.height=c.height(),c.width(a.current.width),c.height()>d.height&&(c.width(d.width+1),d.width=c.width(),d.height=c.height()),b=c.contents().detach(),c.remove());break;case"image":b=d.tpl.image.replace("{href}",d.href);d.aspectRatio=!0;break;case"swf":b=d.tpl.swf.replace(/\{width\}/g,d.width).replace(/\{height\}/g,d.height).replace(/\{href\}/g,d.href)}if("iframe"===g){b=e(d.tpl.iframe.replace("{rnd}",(new Date).getTime())).attr("scrolling",d.scrolling);d.scrolling="auto";if(d.autoSize){b.width(d.width);a.showLoading();b.data("ready",!1).appendTo(a.inner).bind({onCancel:function(){e(this).unbind();a._afterZoomOut()},load:function(){var b=e(this),c;try{this.contentWindow.document.location&&(c=b.contents().find("body").height()+12,b.height(c))}catch(g){d.autoSize=!1}!1===b.data("ready")?(a.hideLoading(),c&&(a.current.height=c),a._beforeShow(),b.data("ready",!0)):c&&a.update()}}).attr("src",d.href);return}b.attr("src",d.href)}else if("image"===g||"swf"===g)d.autoSize=!1,d.scrolling="visible";a.inner.append(b);a._beforeShow()},_beforeShow:function(){a.coming=null;a.trigger("beforeShow");a._setDimension();a.wrap.hide().removeClass("fancybox-tmp");a.bindEvents();a._preloadImages();a.transitions[a.isOpened?a.current.nextMethod:a.current.openMethod]()},_setDimension:function(){var b=a.wrap,c=a.outer,d=a.inner,g=a.current,f=a.getViewport(),k=g.margin,h=2*g.padding,i=g.width,j=g.height,o=g.maxWidth,l=g.maxHeight,p=g.minWidth,m=g.minHeight,n;f.w-=k[1]+k[3];f.h-=k[0]+k[2];-1<i.toString().indexOf("%")&&(i=(f.w-h)*parseFloat(i)/100);-1<j.toString().indexOf("%")&&(j=(f.h-h)*parseFloat(j)/100);k=i/j;i+=h;j+=h;g.fitToView&&(o=Math.min(f.w,o),l=Math.min(f.h,l));g.aspectRatio?(i>o&&(i=o,j=(i-h)/k+h),j>l&&(j=l,i=(j-h)*k+h),i<p&&(i=p,j=(i-h)/k+h),j<m&&(j=m,i=(j-h)*k+h)):(i=Math.max(p,Math.min(i,o)),j=Math.max(m,Math.min(j,l)));i=Math.round(i);j=Math.round(j);e(b.add(c).add(d)).width("auto").height("auto");d.width(i-h).height(j-h);b.width(i);n=b.height();if(i>o||n>l)for(;(i>o||n>l)&&i>p&&n>m;)j-=10,g.aspectRatio?(i=Math.round((j-h)*k+h),i<p&&(i=p,j=(i-h)/k+h)):i-=10,d.width(i-h).height(j-h),b.width(i),n=b.height();g.dim={width:i,height:n};g.canGrow=g.autoSize&&j>m&&j<l;g.canShrink=!1;g.canExpand=!1;if(i-h<g.width||j-h<g.height)g.canExpand=!0;else if((i>f.w||n>f.h)&&i>p&&j>m)g.canShrink=!0;b=n-h;a.innerSpace=b-d.height();a.outerSpace=b-c.height()},_getPosition:function(b){var c=a.current,d=a.getViewport(),e=c.margin,f=a.wrap.width()+e[1]+e[3],k=a.wrap.height()+e[0]+e[2],h={position:"absolute",top:e[0]+d.y,left:e[3]+d.x};if(c.fixed&&(!b||!1===b[0])&&k<=d.h&&f<=d.w)h={position:"fixed",top:e[0],left:e[3]};h.top=Math.ceil(Math.max(h.top,h.top+(d.h-k)*c.topRatio))+"px";h.left=Math.ceil(Math.max(h.left,h.left+.5*(d.w-f)))+"px";return h},_afterZoomIn:function(){var b=a.current,c=b.scrolling;a.isOpen=a.isOpened=!0;a.wrap.addClass("fancybox-opened").css("overflow","visible");a.update();a.inner.css("overflow","yes"===c?"scroll":"no"===c?"hidden":c);if(b.closeClick||b.nextClick)a.inner.css("cursor","pointer").bind("click.fb",b.nextClick?a.next:a.close);b.closeBtn&&e(b.tpl.closeBtn).appendTo(a.outer).bind("click.fb",a.close);b.arrows&&1<a.group.length&&((b.loop||0<b.index)&&e(b.tpl.prev).appendTo(a.inner).bind("click.fb",a.prev),(b.loop||b.index<a.group.length-1)&&e(b.tpl.next).appendTo(a.inner).bind("click.fb",a.next));a.trigger("afterShow");a.opts.autoPlay&&!a.player.isActive&&(a.opts.autoPlay=!1,a.play())},_afterZoomOut:function(){a.trigger("afterClose");a.wrap.trigger("onReset").remove();e.extend(a,{group:{},opts:{},current:null,isActive:!1,isOpened:!1,isOpen:!1,wrap:null,outer:null,inner:null})}});a.transitions={getOrigPosition:function(){var b=a.current,c=b.element,d=b.padding,g=e(b.orig),f={},k=50,h=50;!g.length&&b.isDom&&e(c).is(":visible")&&(g=e(c).find("img:first"),g.length||(g=e(c)));g.length?(f=g.offset(),g.is("img")&&(k=g.outerWidth(),h=g.outerHeight())):(b=a.getViewport(),f.top=b.y+.5*(b.h-h),f.left=b.x+.5*(b.w-k));return f={top:Math.ceil(f.top-d)+"px",left:Math.ceil(f.left-d)+"px",width:Math.ceil(k+2*d)+"px",height:Math.ceil(h+2*d)+"px"}},step:function(b,c){var d,e,f;if("width"===c.prop||"height"===c.prop)e=f=Math.ceil(b-2*a.current.padding),"height"===c.prop&&(d=(b-c.start)/(c.end-c.start),c.start>c.end&&(d=1-d),e-=a.innerSpace*d,f-=a.outerSpace*d),a.inner[c.prop](e),a.outer[c.prop](f)},zoomIn:function(){var b=a.wrap,c=a.current,d,g;d=c.dim;"elastic"===c.openEffect?(g=e.extend({},d,a._getPosition(!0)),delete g.position,d=this.getOrigPosition(),c.openOpacity&&(d.opacity=0,g.opacity=1),a.outer.add(a.inner).width("auto").height("auto"),b.css(d).show(),b.animate(g,{duration:c.openSpeed,easing:c.openEasing,step:this.step,complete:a._afterZoomIn})):(b.css(e.extend({},d,a._getPosition())),"fade"===c.openEffect?b.fadeIn(c.openSpeed,a._afterZoomIn):(b.show(),a._afterZoomIn()))},zoomOut:function(){var b=a.wrap,c=a.current,d;"elastic"===c.closeEffect?("fixed"===b.css("position")&&b.css(a._getPosition(!0)),d=this.getOrigPosition(),c.closeOpacity&&(d.opacity=0),b.animate(d,{duration:c.closeSpeed,easing:c.closeEasing,step:this.step,complete:a._afterZoomOut})):b.fadeOut("fade"===c.closeEffect?c.closeSpeed:0,a._afterZoomOut)},changeIn:function(){var b=a.wrap,c=a.current,d;"elastic"===c.nextEffect?(d=a._getPosition(!0),d.opacity=0,d.top=parseInt(d.top,10)-200+"px",b.css(d).show().animate({opacity:1,top:"+=200px"},{duration:c.nextSpeed,easing:c.nextEasing,complete:a._afterZoomIn})):(b.css(a._getPosition()),"fade"===c.nextEffect?b.hide().fadeIn(c.nextSpeed,a._afterZoomIn):(b.show(),a._afterZoomIn()))},changeOut:function(){var b=a.wrap,c=a.current,d=function(){e(this).trigger("onReset").remove()};b.removeClass("fancybox-opened");"elastic"===c.prevEffect?b.animate({opacity:0,top:"+=200px"},{duration:c.prevSpeed,easing:c.prevEasing,complete:d}):b.fadeOut("fade"===c.prevEffect?c.prevSpeed:0,d)}};a.helpers.overlay={overlay:null,update:function(){var a,c;this.overlay.width(0).height(0);e.browser.msie?(a=Math.max(m.documentElement.scrollWidth,m.body.scrollWidth),c=Math.max(m.documentElement.offsetWidth,m.body.offsetWidth),a=a<c?l.width():a):a=q.width();this.overlay.width(a).height(q.height())},beforeShow:function(b){this.overlay||(b=e.extend(!0,{speedIn:"fast",closeClick:!0,opacity:1,css:{background:"black"}},b),this.overlay=e('<div id="fancybox-overlay"></div>').css(b.css).appendTo("body"),this.update(),b.closeClick&&this.overlay.bind("click.fb",a.close),l.bind("resize.fb",e.proxy(this.update,this)),this.overlay.fadeTo(b.speedIn,b.opacity))},onUpdate:function(){this.update()},afterClose:function(a){this.overlay&&this.overlay.fadeOut(a.speedOut||0,function(){e(this).remove()});this.overlay=null}};a.helpers.title={beforeShow:function(b){var c;if(c=a.current.title)c=e('<div class="fancybox-title fancybox-title-'+b.type+'-wrap">'+c+"</div>").appendTo("body"),"float"===b.type&&(c.width(c.width()),c.wrapInner('<span class="child"></span>'),a.current.margin[2]+=Math.abs(parseInt(c.css("margin-bottom"),10))),c.appendTo("over"===b.type?a.inner:"outside"===b.type?a.wrap:a.outer)}};e.fn.fancybox=function(b){var c=e(this),d=this.selector||"",g,f=function(f){var h=this,i="rel",j=h[i],l=g;!f.ctrlKey&&!f.altKey&&!f.shiftKey&&!f.metaKey&&(f.preventDefault(),j||(i="data-fancybox-group",j=e(h).attr("data-fancybox-group")),j&&""!==j&&"nofollow"!==j&&(h=d.length?e(d):c,h=h.filter("["+i+'="'+j+'"]'),l=h.index(this)),b.index=l,a.open(h,b))},b=b||{};g=b.index||0;d?q.undelegate(d,"click.fb-start").delegate(d,"click.fb-start",f):c.unbind("click.fb-start").bind("click.fb-start",f);return this}}(window,document,jQuery);!function($,F){var W=$(window),D=$(document),isMobile=typeof document.createTouch!=="undefined";$.extend(F.defaults,{wrapCSS:"photoset-fancybox",scrolling:"visible",aspectRatio:true,loop:false,prevSpeed:600,nextSpeed:600,keys:{next:[13,32,39],prev:[37],close:[27]},helpers:{overlay:null,PhotosetOverlay:{}}});F.transitions.changeIn=function(){var wrap=F.wrap,current=F.current,startPos=F._getPosition(true);if(!F.isForward){startPos.left=parseInt(startPos.left,10)-1500+"px";wrap.css(startPos).show().animate({left:"+=1500px"},{duration:current.nextSpeed,complete:F._afterZoomIn})}else{startPos.left=parseInt(startPos.left,10)+1500+"px";wrap.css(startPos).show().animate({left:"-=1500px"},{duration:current.nextSpeed,complete:F._afterZoomIn})}};F.transitions.changeOut=function(){var wrap=F.wrap,current=F.current,cleanUp=function(){$(this).trigger("onReset").remove()},leftAmt;wrap.removeClass("fancybox-opened");if(F.isForward){leftAmt="-=1500px"}else{leftAmt="+=1500px"}if(current.prevEffect==="elastic"){wrap.animate({opacity:.4,left:leftAmt},{duration:current.prevSpeed,complete:cleanUp})}};F.next=function(){if(F.current){F.isForward=true;F.jumpto(F.current.index+1)}};F.prev=function(){if(F.current){F.isForward=false;F.jumpto(F.current.index-1)}};F.closeOrig=F.close;F.close=function(a){if(typeof a==="object"&&a.target){var target=$(a.target);if(target.attr("id")===F.overlayId||target.hasClass("fancybox-close")&&$(this).attr("id")!==F.overlayId||target.hasClass("transparency"))F.closeOrig(a);return}F.closeOrig(a)};F._afterZoomOut=function(){F.trigger("afterClose")};F.getViewport=function(){return{x:W.scrollLeft(),y:0,w:W.width(),h:W.height()}};F.originalUrl=window.location.href;F.overlayId="photoset-overlay";F.overlayWrap='<div id="'+F.overlayId+'"><div class="transparency"></div></div>';F.helpers.PhotosetOverlay={overlay:null,beforeLoad:function(opts){if(this.overlay){return}opts=$.extend(true,{speedIn:"fast",closeClick:true},opts);this.overlay=$(F.overlayWrap).appendTo("body");if(opts.closeClick){this.overlay.bind("click.fb",F.close)}this.overlay.fadeTo(opts.speedIn,opts.opacity)},beforeShow:function(opts){F.wrap.detach().appendTo("div#"+F.overlayId)},afterClose:function(opts){F.wrap.trigger("onReset").remove();if(this.overlay){this.overlay.remove();this.overlay=null}$.extend(F,{group:{},opts:{},current:null,isActive:false,isOpened:false,isOpen:false,wrap:null,outer:null,inner:null})}}}(jQuery,jQuery.fancybox);!function(a,b,c,d){var e=a(b);a.fn.lazyload=function(f){function g(){var b=0;i.each(function(){var c=a(this);if(!j.skip_invisible||c.is(":visible"))if(a.abovethetop(this,j)||a.leftofbegin(this,j));else if(a.belowthefold(this,j)||a.rightoffold(this,j)){if(++b>j.failure_limit)return!1}else c.trigger("appear"),b=0})}var h,i=this,j={threshold:0,failure_limit:0,event:"scroll",effect:"show",container:b,data_attribute:"original",skip_invisible:!0,appear:null,load:null,placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC"};return f&&(d!==f.failurelimit&&(f.failure_limit=f.failurelimit,delete f.failurelimit),d!==f.effectspeed&&(f.effect_speed=f.effectspeed,delete f.effectspeed),a.extend(j,f)),h=j.container===d||j.container===b?e:a(j.container),0===j.event.indexOf("scroll")&&h.bind(j.event,function(){return g()}),this.each(function(){var b=this,c=a(b);b.loaded=!1,(c.attr("src")===d||c.attr("src")===!1)&&c.is("img")&&c.attr("src",j.placeholder),c.one("appear",function(){if(!this.loaded){if(j.appear){var d=i.length;j.appear.call(b,d,j)}a("<img />").bind("load",function(){var d=c.attr("data-"+j.data_attribute);c.hide(),c.is("img")?c.attr("src",d):c.css("background-image","url('"+d+"')"),c[j.effect](j.effect_speed),b.loaded=!0;var e=a.grep(i,function(a){return!a.loaded});if(i=a(e),j.load){var f=i.length;j.load.call(b,f,j)}}).attr("src",c.attr("data-"+j.data_attribute))}}),0!==j.event.indexOf("scroll")&&c.bind(j.event,function(){b.loaded||c.trigger("appear")})}),e.bind("resize",function(){g()}),/(?:iphone|ipod|ipad).*os 5/gi.test(navigator.appVersion)&&e.bind("pageshow",function(b){b.originalEvent&&b.originalEvent.persisted&&i.each(function(){a(this).trigger("appear")})}),a(c).ready(function(){g()}),this},a.belowthefold=function(c,f){var g;return g=f.container===d||f.container===b?(b.innerHeight?b.innerHeight:e.height())+e.scrollTop():a(f.container).offset().top+a(f.container).height(),g<=a(c).offset().top-f.threshold},a.rightoffold=function(c,f){var g;return g=f.container===d||f.container===b?e.width()+e.scrollLeft():a(f.container).offset().left+a(f.container).width(),g<=a(c).offset().left-f.threshold},a.abovethetop=function(c,f){var g;return g=f.container===d||f.container===b?e.scrollTop():a(f.container).offset().top,g>=a(c).offset().top+f.threshold+a(c).height()},a.leftofbegin=function(c,f){var g;return g=f.container===d||f.container===b?e.scrollLeft():a(f.container).offset().left,g>=a(c).offset().left+f.threshold+a(c).width()},a.inviewport=function(b,c){return!(a.rightoffold(b,c)||a.leftofbegin(b,c)||a.belowthefold(b,c)||a.abovethetop(b,c))},a.extend(a.expr[":"],{"below-the-fold":function(b){return a.belowthefold(b,{threshold:0})},"above-the-top":function(b){return!a.belowthefold(b,{threshold:0})},"right-of-screen":function(b){return a.rightoffold(b,{threshold:0})},"left-of-screen":function(b){return!a.rightoffold(b,{threshold:0})},"in-viewport":function(b){return a.inviewport(b,{threshold:0})},"above-the-fold":function(b){return!a.belowthefold(b,{threshold:0})},"right-of-fold":function(b){return a.rightoffold(b,{threshold:0})},"left-of-fold":function(b){return!a.rightoffold(b,{threshold:0})}})}(jQuery,window,document);!function($){$.fn.notes=function(method){var methods;methods={};methods.init=function(options,editable,container){methods.setEditable(editable);return this.each(function(){var noteHolder,self;self=$(this);noteHolder=$('<div class="note-holder"></div>');return setTimeout(function(){var makeOptions,nfo,option,_i,_len,_results;nfo=methods.extractInfo(self,container);noteHolder.addClass(nfo.imgId);noteHolder.attr("id","holder_"+nfo.imgId);methods.placeNoteHolder(noteHolder,nfo);if(container!=null){container.append(noteHolder)}else{$("body").append(noteHolder)}if(methods.editable){noteHolder.css({"z-index":200});methods.bindNoteHolder(noteHolder)}makeOptions=function(opt){var literal;opt.parentWidth=nfo.width;opt.parentHeight=nfo.height;opt.noteHolder=noteHolder;literal=[opt];return methods.display.apply(self,literal)};if(options){_results=[];for(_i=0,_len=options.length;_i<_len;_i++){option=options[_i];_results.push(makeOptions(option))}return _results}},10)})};methods.extractInfo=function(elm,container){var compoundClass,eclass,height,imgId,offset,width;width=elm.width();height=elm.height();eclass=elm.attr("class");offset=container?elm.offsetParent().position():elm.offset();if(eclass!=null){compoundClass=eclass.indexOf(" ")}if(compoundClass!=null&&compoundClass!==-1){imgId=eclass.split(" ")[1]}else{imgId=eclass}return{width:width,height:height,offset:offset,imgId:imgId}};methods.placeNoteHolder=function(noteHolder,nfo){if(nfo!=null&&nfo.offset!=null){return noteHolder.css({left:nfo.offset.left+"px",top:nfo.offset.top+"px"})}};methods.buildNoteInfo=function(note,action){var data,height,hheight,holder,hwidth,imgId,left,pos,text,top,width;pos=note.position();holder=note.parent();hwidth=holder.width();hheight=holder.height();imgId=holder.attr("class").split(" ")[1].substring(3);data={};data.action=action;data.imageID=imgId;top=pos.top/hheight;left=pos.left/hwidth;width=note.width()/hwidth;height=note.height()/hheight;text=note.find("textarea").val();if(!text){text=note.find(".note-text-value").html()}if(text){data.text=text.replace(/\n/g,"<br/>").replace(/"/g,'\\"')}data.json='{"top":'+top+',"left":'+left+',"width":'+width+',"height":'+height+',"text":"'+data.text+'"}';return data};methods.add=function(note){var data;data=methods.buildNoteInfo(note,"ADD");return $.post("/ajax/imageNote",data,function(response){note.attr("id",response);note.find(".note-text").html(methods.buildTextNode(data.text.replace(/\\"/g,'"')));return methods.bind(note)},"text")};methods.buildTextNode=function(text){return $('<div class="note-text-value">'+text+'</div><a class="edit-note" href="#">edit</a>')};methods.buildEditNode=function(text,classname){text=text.replace(/<br>/g,"\n");if(!classname){return $("<textarea>"+text+'</textarea><br/><a class="delete little-button" href="#">delete</a><a class="save little-button" href="#">save</a>')}else{return $("<textarea>"+text+'</textarea><br/><a class="delete little-button" href="#">delete</a><a class="'+classname+' little-button" href="#">save</a>')}};methods.save=function(note){var data;data=methods.buildNoteInfo(note,"MODIFY");data.noteID=note.attr("id");if(data.noteID){return $.post("/ajax/imageNote",data,function(response){return methods.bind(note)})}};methods.update=function(note){var noteText,text;noteText=note.find(".note-text");text=noteText.find(".note-text-value").html();noteText.html(methods.buildEditNode(text,"edit"));methods.bind(note);return noteText.find("a.edit").click(function(evt){var data;evt.preventDefault();data=methods.buildNoteInfo(note,"MODIFY");if(data.text!=null){data.noteID=note.attr("id");return $.post("/ajax/imageNote",data,function(response){noteText.html(methods.buildTextNode(noteText.find("textarea").val()));return methods.bind(note)})}else{return feedBack.add("Please enter text in order to save.")}})};methods.remove=function(note){var data;data=methods.buildNoteInfo(note,"DELETE");data.noteID=note.attr("id");if(data.noteID){$.post("/ajax/imageNote",data)}return note.fadeOut(function(){return note.remove()})};methods.bindNoteHolder=function(holder){var note;note=null;$("div.note-holder").mousedown(function(evt){evt.preventDefault();note=methods.userCreateBox(evt,holder);return methods.bind(note,note.height())});return this};methods.display=function(note){var left,noteHeight,noteWidth,top;left=Math.round(note.parentWidth*note.left);top=Math.round(note.parentHeight*note.top);noteWidth=Math.round(note.parentWidth*note.width);noteHeight=Math.round(note.parentHeight*note.height);methods.drawBox({left:left,top:top,width:noteWidth,height:noteHeight,note:note});return this};methods.drawBox=function(opts){var note,noteid;noteid=opts.note.id?opts.note.id:opts.note.noteID;note=$('<div id="'+noteid+'" class="note-border"><div class="note-text"><div class="note-text-value">'+opts.note.text+"</div></div></div>");opts.note.noteHolder.append(note);if(methods.editable){note.find(".note-text").append('<a href="#" class="edit-note">edit</a>')}note.css({width:opts.width+"px",left:opts.left+"px",height:opts.height+"px",top:opts.top+"px"});methods.bind(note,opts.height);return this};methods.userCreateBox=function(evt,noteHolder){var note;note=$('<div class="note-border"><div class="note-text"></div></div>');note.find(".note-text").append(methods.buildEditNode(""));noteHolder.append(note);note.mousedown(function(md_evt){return md_evt.stopPropagation()});if(!/MSIE (\d+\.\d+);/.test(navigator.userAgent)){note.css({top:evt.layerY+"px",left:evt.layerX+"px",width:"50px",height:"50px"})}else{note.css({top:evt.offsetY+"px",left:evt.offsetX+"px",width:"50px",height:"50px"})}return note};methods.updateBoxSize=function(evt,note){var pos;pos=note.position();return note.css({width:Math.abs(pos.left+evt.layerX)+"px",height:Math.abs(pos.top+evt.layerY)+"px"})};methods.setNoteTextTop=function(noteText,height){return noteText.css({top:height+"px"})};methods.noteHover=function(note,height,noteText){var hovering,_self;_self=this;hovering=note.hover(function(){clearTimeout(_self.timer);methods.setNoteTextTop(noteText,height);$("div.note-text").hide();return noteText.show()},function(){clearTimeout(_self.timer);return _self.timer=setTimeout(function(){return noteText.fadeOut()},1500)});return hovering};methods.setEditable=function(bool){this.editable=bool;return this};methods.bind=function(note,height){var hovering,noteText,self;noteText=note.find("div.note-text");hovering=methods.noteHover(note,height,noteText);if(methods.editable){self=this;if(note.resizable!=null){note.resizable({containment:"parent",start:function(event,ui){noteText.hide();return note.unbind("hover",hovering)},resize:function(event,ui){noteText.hide();return note.unbind("hover",hovering)},stop:function(event,ui){height=note.height();hovering=methods.noteHover(note,height,noteText);methods.setNoteTextTop(noteText,height);methods.save(note);return noteText.show()}})}if(note.draggable!=null){note.draggable({containment:"parent",stop:function(event,ui){return methods.save(note)}})}note.mousedown(function(evt){return evt.stopPropagation()});noteText.find("a.save").click(function(evt){evt.preventDefault();return methods.add(note)});noteText.find("a.delete").click(function(evt){evt.preventDefault();return methods.remove(note)});return noteText.find("a.edit-note").click(function(evt){evt.preventDefault();return methods.update(note)})}};if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof method==="object"||!method){return methods.init.apply(this,arguments)}else{return $.error("Method "+method+" does not exist on jQuery.notes")}}}(window.jQuery);!function($,_){var defaults={width:"100%",gutter:"0px",maxRowsVisible:null,preloadImages:false,rowOfOneAspectRatio:4/3,maxWidth:null};function toJsArray(jqArray){return _.map(jqArray,function(el){return $(el)})}function toJqArray(arrayOfJqObjects){return $(arrayOfJqObjects).map(function(){return this.toArray()})}function Photoset(element,options){_.bindAll(this,"resizeAndShowLazyImages");this.$element=$(element);this.rows=[];this.options=$.extend({},defaults,options);this.gutterVal=parseInt(this.options.gutter,10);this.photosetItems=toJsArray(this.$element.find(".photoset-item"));this.photosetRows=[];this.photosetCells=[];this.setupLayout()}Photoset.prototype={setupLayout:function(){var self=this,options=this.options,$elem=this.$element;this.setupImagesPerRows();this.wrapRowsAndColumns();this.wrapCells();this.setCellWidths();this.setLazyLoadedImages();_.defer(function(){$elem.trigger("photoset.imagesShown",$elem.find("img:not(.lazy-img)"))});this.showHiddenRowsUpToMaxRowsVisible();if(this.options.preloadImages){this.preloadImages().then(this.resizeAndShowLazyImages)}else{this.resizeAndShowLazyImages()}},resizeAndShowLazyImages:function(){this.setupResize();this.showLazyImages()},preloadImages:function(){var $elem=this.$element,$images=$elem.find("img"),deferreds=[];_.each($images,function(img){deferreds.push(this.preloadImage($(img)))},this);return $.when.apply(null,deferreds)},preloadImage:function($img){var image=new Image,deferred=$.Deferred();image.onload=function(){$img.data("orig-height",image.height);$img.data("orig-width",image.width);deferred.resolve()};image.src=$img.data("original");return deferred},setupResize:function(){var self=this;this.resizePhotosetIfNecessary();$(window).on("resize",_.debounce(function(){self.clearRowHeights();self.$element.trigger("photoset.beforeResize")},1e3,true));$(window).on("resize",_.debounce(function(){self.resizePhotosetIfNecessary();self.$element.trigger("photoset.afterResize")},1e3))},setupImagesPerRows:function(){var rows=[],segments=this.mapPhotosetItemsByContiguousType();_.each(segments,function(segment){if(segment.type==="image"){this.placeImagesInRowsArray(rows,segment.items)}else{this.placeVideosInRowsArray(rows,segment.items)}},this);this.rows=rows},mapPhotosetItemsByContiguousType:function(){return _.reduce(this.photosetItems,function(memo,$photosetItem){var itemType=$photosetItem.hasClass("photoset-image")?"image":"video",lastSegment=_.last(memo);if(_.isEmpty(lastSegment)){memo.push({type:itemType,items:[$photosetItem]})}else{if(lastSegment.type===itemType){lastSegment.items.push($photosetItem)}else{memo.push({type:itemType,items:[$photosetItem]})}}return memo},[])},setLazyLoadedImages:function(){var maxContainerWidth=this.options.maxWidth,smallWidthCutOff=320,mediumWidthCutOff=620,largeWidthCutOff=1024;_.each(this.photosetCells,function($cell){if(!$cell.hasClass("image-cell"))return;var $img=$cell.find("img"),defaultFileSize=$img.data("medium"),isAnimatedGif=defaultFileSize.match(/\.gif/i),maxRequiredImageWidth=maxContainerWidth*$cell.data("percentage-width")/100,chosenFileSize=null;if(maxRequiredImageWidth>largeWidthCutOff){chosenFileSize=$img.data("orig")}else if(maxRequiredImageWidth>mediumWidthCutOff){chosenFileSize=$img.data("large")}else if(maxRequiredImageWidth>smallWidthCutOff){chosenFileSize=$img.data("medium")}else{chosenFileSize=$img.data("small")}if(!isAnimatedGif&&$img.data("orig-width")>maxRequiredImageWidth){chosenFileSize+="?width={0}".format(maxRequiredImageWidth)}$img.attr("data-original",chosenFileSize)})},setLazyloadPropertiesForImage:function($imgItem,imageSize){var $img=$imgItem.find("img");$img.attr("data-original",$img.data(imageSize))},setLazyloadPropertiesForImages:function($imgItems,beginIndex,endIndex,imageSize){for(var i=beginIndex;i<=endIndex;i++){this.setLazyloadPropertiesForImage($imgItems.eq(i),imageSize)}},placeVideosInRowsArray:function(rows,videoItems){_.each(videoItems,function($item){rows.push(1)})},placeImagesInRowsArray:function(rows,imageItems){var numImages=imageItems.length,imageSizes=this.options.imageSizes;if(numImages<=6){rows.push(1);if(numImages==2){rows.push(1)}else if(numImages==3){rows.push(2)}else if(numImages==4){rows.push(3)}else if(numImages==5){rows.push(2,2)}else if(numImages==6){rows.push(2,3)}}else{var partitions=parseInt(imageItems.length/6);for(var i=0;i<partitions;i++){this.placeImagesInRowsArray(rows,imageItems.slice(i*6,(i+1)*6))}var rem=imageItems.length%6;if(rem>0){this.placeImagesInRowsArray(rows,imageItems.slice(imageItems.length-rem))}}},wrapRowsAndColumns:function(){var self=this,options=this.options,$elem=this.$element,items=this.photosetItems,itemsLength=items.length,itemIndex=0;_.each(this.rows,function(val){var rowStart=itemIndex,rowEnd=itemIndex+val,$itemSlice=toJqArray(items.slice(rowStart,rowEnd)),itemsCount=$itemSlice.length,$photosetRow;$photosetRow=$('<div class="photoset-row">').addClass("cols-"+val).addClass(rowStart!==0?"hidden-row":"");$itemSlice.wrapAll($photosetRow);$itemSlice.removeClass("hidden-item");itemIndex=rowEnd});$elem.find(".photoset-row:not(:last-child)").css({"margin-bottom":options.gutter});this.photosetRows=toJsArray($elem.find(".photoset-row"))},wrapCells:function(){var self=this,options=this.options,$elem=this.$element,items=this.photosetItems;_.each(items,function($item){if($item.hasClass("photoset-video")){$item.wrapAll('<div class="photoset-cell video-cell"/>')}else{$item.wrapAll('<div class="photoset-cell image-cell"/>')}});$elem.find(".photoset-cell:not(:last-child)").css({"padding-right":this.gutterVal/2+"px"});$elem.find(".photoset-cell:not(:first-child)").css({"padding-left":this.gutterVal/2+"px"});this.photosetCells=toJsArray($elem.find(".photoset-cell"))},resizePhotosetIfNecessary:function(){var $elem=this.$element,photosetWidth=$elem.width().toString();if(photosetWidth!==$elem.data("width")){this.setRowHeightsAndCenterImages();$elem.data("width",photosetWidth)}},setMaxImageWidthForRowOfOne:function($row){if($row.hasClass("cols-1")){var $image=$row.find("img:eq(0)");if("none"===$image.css("maxWidth")){$image.css("maxWidth",$image.data("orig-width")+"px")}}},setMaxImageHeightForRowOfOne:function($row){if($row.hasClass("cols-1")){var $image=$row.find("img:eq(0)");if("none"===$image.css("maxWidth")){$image.css("maxWidth",$image.data("orig-width")+"px")}}},setCellWidths:function(){_.each(this.photosetRows,function($row){if($row.hasClass("cols-1")){this.setCellWidthForRowOfOne($row)}else if($row.hasClass("cols-2")){this.setCellWidthsForRowOfTwo($row)}else if($row.hasClass("cols-3")){var scaledWidth=1/3*100;$row.find(".photoset-cell").css({width:scaledWidth+"%"}).data("percentage-width",scaledWidth)}},this)},setCellWidthForRowOfOne:function($row){var $img=$row.find("img:eq(0)"),originalWidth=$img.data("orig-width"),originalHeight=$img.data("orig-height");if(originalHeight<=originalWidth){$row.find(".photoset-cell").css({width:"100%"}).data("percentage-width",100)}else{var photosetWidth=this.$element.width(),maxHeight=1/this.options.rowOfOneAspectRatio*photosetWidth;if(originalHeight>maxHeight){var heightInContainer=originalHeight/originalWidth*photosetWidth,scaledWidth=maxHeight*100/heightInContainer;$row.find(".photoset-cell").css({width:scaledWidth+"%"}).data("percentage-width",scaledWidth)}}},setCellWidthsForRowOfTwo:function($row){var $cells=$row.find(".photoset-cell"),$img1=$row.find("img:eq(0)"),$img2=$row.find("img:eq(1)"),aspect1=$img1.data("orig-width")/$img1.data("orig-height"),aspect2=$img2.data("orig-width")/$img2.data("orig-height"),aspectTotal=aspect1+aspect2,percentWidth1=aspect1/aspectTotal*100;percentWidth2=aspect2/aspectTotal*100;$cells.eq(0).css({width:percentWidth1+"%"}).data("percentage-width",percentWidth1);$cells.eq(1).css({width:percentWidth2+"%"}).data("percentage-width",percentWidth2)},setRowHeightAndCenterImagesInRow:function($row,photosetWidth){var shortestImgHeight=1e5,$items=$row.find(".photoset-item"),self=this;$row.find("img").each(function(){var $candidateImg=$(this),candidateImgHeight=self.getHeightProportionalToCellWidth($candidateImg,photosetWidth);if(candidateImgHeight<shortestImgHeight){shortestImgHeight=candidateImgHeight}});$row.height(shortestImgHeight);$items.height(shortestImgHeight);$row.find("img").each(function(){var $img=$(this),imgHeight=self.getHeightProportionalToCellWidth($img,photosetWidth);var marginOffset=(shortestImgHeight-imgHeight)*.5+"px";$img.css({"margin-top":marginOffset})})},setRowHeightsAndCenterImages:function(){var photosetWidth=this.$element.width().toString();_.each(this.photosetRows,function($row){if(!$row.hasClass("cols-1")){this.setRowHeightAndCenterImagesInRow($row,photosetWidth)}},this)},clearRowHeights:function(){toJqArray(this.photosetRows).css("height","auto");toJqArray(this.photosetItems).css("height","auto")},getRowCount:function(){return this.rows.length},getHeightProportionalToCellWidth:function($img,photosetWidth){return Math.floor($img.data("orig-height")/$img.data("orig-width")*$img.closest(".photoset-cell").width())},showHiddenRowsUpToMaxRowsVisible:function(){var maxRowsVisible=this.options.maxRowsVisible,shouldHideRows=maxRowsVisible&&this.getRowCount()>maxRowsVisible,$elem=this.$element,rows=this.photosetRows;if(!shouldHideRows){$elem.find(".hidden-row").removeClass("hidden-row")}else{for(var i=0;i<maxRowsVisible;i++){rows[i].removeClass("hidden-row")}}},showAllRows:function(){this.$element.find(".hidden-row").removeClass("hidden-row");this.setRowHeightsAndCenterImages();$("html,body").animate({scrollTop:$(window).scrollTop()+1},100)},showLazyImages:function($row){var $elem=this.$element;$elem.find(".lazy-img").show().lazyload({effect:"fadeIn",threshold:200,load:function(){$elem.trigger("photoset.imagesShown",$(this))}})}};$.fn.photoset=function(options){return this.each(function(){var $this=$(this),data=$this.data("photoset");if(!data)$this.data("photoset",data=new Photoset(this,options));if(typeof options=="string")data[option].call($this)})}}(jQuery,_);Ibles.package("Ibles.views");Ibles.views.PhotosetView=Backbone.View.extend({events:{"click a.photoset-link":"photosetLinkClicked","hover a.photoset-link":"mouseHoverLink","click a.photoset-showmore":"showAllPhotosetRows"},initialize:function(options){_.bindAll(this,"beforePhotosetResize","afterPhotosetResize","renderImageNotes");this.$el.photoset(options);this.maxRowsVisible=options.maxRowsVisible;this.photoset=this.$el.data("photoset");this.enableShowMoreToggle();this.bindEvents()},bindEvents:function(){this.$el.on("photoset.beforeResize",this.beforePhotosetResize);this.$el.on("photoset.afterResize",this.afterPhotosetResize);this.$el.on("photoset.imagesShown",this.renderImageNotes)},enableShowMoreToggle:function(){var maxRowsVisible=this.maxRowsVisible;
if(maxRowsVisible){if(this.photoset.getRowCount()>maxRowsVisible){this.$el.find(".photoset-showmore").css({display:"block"})}}},renderImageNotes:function(event,images){var $images=$(images);$images.each(function(){var $image=$(this),notesContainer=$image.closest(".photoset-cell"),imageNotes=$image.data("notes"),imageId=$image.data("image-id");if($image.closest(".photoset-row").children().size()===1){if(imageNotes&&imageNotes.length){$image.addClass("photo img"+imageId);$image.notes(imageNotes,false,notesContainer)}}})},beforePhotosetResize:function(){this.$el.find(".note-holder").remove()},afterPhotosetResize:function(){this.renderImageNotes(null,this.$(".photoset-image img"))},showAllPhotosetRows:function(e){e.preventDefault();this.$el.find(".photoset-showmore").hide();this.photoset.showAllRows()},photosetLinkClicked:function(e){e.preventDefault();new Ibles.views.PhotosetOverlay({el:this.el})},mouseHoverLink:function(e){e.preventDefault();$(e.currentTarget).toggleClass("selected")}});Ibles.views.PhotosetOverlay=Backbone.View.extend({initialize:function(){this.render()},render:function(){var $photosetLinks=this.$el.find(".photoset-link"),self=this;if(!this.processedPhotosetLinks){_.each($photosetLinks,function(link){var $link=$(link);$link.data("original-href",$link.attr("href"));$(link).attr("href",$(link).data("fancybox-href"))});this.processedPhotosetLinks=true}$photosetLinks.fancybox({afterShow:function(){var $fancyBoxInner=$(".fancybox-inner"),$currentLink=$(this.element);if($fancyBoxInner.length){var galleryImg=$fancyBoxInner.find("img:first"),notesJson=$currentLink.find("img:first").data("notes");if(notesJson){galleryImg.notes(notesJson,false,$fancyBoxInner)}$fancyBoxInner.find(".fancybox-image").one("click",function(e){window.location.href=$currentLink.data("original-href")})}}})}});window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["post-comment"]='<div class="post-comment-container">\n    <form class="post-comment-form" name="PostCommentForm">\n        <input class="commentFiles" name="files" type="hidden" value=""/>\n        <div class="post-comment-box">\n            <div class="commenter-image pull-left">\n                <img class="postCommentAvatar" src="<< avatar >>" alt="<< author >>"/>\n            </div>\n            <div class="post-comment-body redactor-container pull-right">\n                <div class="comment-tip redactor-tooltip" data-toggle="tooltip" data-placement="top" title="Highlight text to apply styling"></div>\n                <textarea class="postCommentBody redactorAirComment redactor-textarea" name="content"></textarea>\n                <div class="comment-files hide"></div>\n            </div>\n            <div class="image-bucket instructable-image-bucket clearfix "></div>\n            <div class="post-comment-toolbar clearfix">\n                <div class="policy pull-left">\n                    <img src="<< Ibles.staticUrl(\'img/instructable/comments/be-nice-en.png\') >>"/>\n                    <p>We have a be nice comment policy.<br> Please be positive and constructive.</p>\n                </div>\n                <div class="actions pull-right">\n                    <button class="addCommentImages btn login-required" data-loading-text="Uploading..." data-sourcea="project:addCommentImage">Add Images</button><button class="post-comment-btn btn btn-orange login-required" data-sourcea="project:postCommentReply" data-loading-text="<i class=\'icon-spin icon-large\'></i>">Reply</button>\n                </div>\n            </div>\n        </div>\n    </form>\n</div>';window.Ibles.JST["post-comment-top-level"]='<form class="post-comment-form" name="PostCommentForm">\n    <input class="commentFiles" name="files" type="hidden" value=""/>\n    <div class="post-comment-box clearfix">\n        <div class="commenter-image pull-left">\n            <img class="postCommentAvatar" src="<< avatar >>" alt="Post a comment"/>\n        </div>\n        <div class="post-comment-body redactor-container pull-right">\n            <div class="comment-tip redactor-tooltip" data-toggle="tooltip" data-placement="top" title="Highlight text to apply styling"></div>\n            <textarea class="postCommentBody redactorAirComment redactor-textarea" name="content"></textarea>\n            <div class="alert alert-info imadeit-image-warning hide">\n                <button type="button" class="close">&times;</button>\n                <strong>"I Made It"</strong> comments require images. Uncheck for normal comment.\n            </div>\n            <div class="comment-error hide">\n            </div>\n        </div>\n        <div class="image-bucket instructable-image-bucket clearfix "></div>\n        <div class="post-comment-toolbar clearfix">\n            <div class="policy pull-left">\n                <img src="<< Ibles.staticUrl(\'img/instructable/comments/be-nice-en.png\') >>" alt="Be nice!"/>\n                <p>We have a be nice comment policy.<br> Please be positive and constructive.</p>\n            </div>\n            <div class="comment-actions pull-right">\n                <button class="comment-imadeit-toggle btn"><i class="icon icon-checkmark1 hide"></i><i class="icon icon-imadeit"></i>&nbsp;   I Made it!</button>\n                <button class="addCommentImages btn login-required" data-loading-text="Uploading..." data-sourcea="project:addCommentImage"><i class="icon icon-camera selected"></i>&nbsp;    Add Images</button>\n                <button class="btn post-comment-btn btn-orange login-required" data-sourcea="project:postComment" data-loading-text="<i class=\'icon-spin icon-large\'></i>">Post Comment</button>\n            </div>\n        </div>\n    </div>\n</form>';window.Ibles.JST["comment-list-item"]='<div class="comment" id="comment-<<id>>">\n    <div class="achievement-holder"></div>\n    <div class="avatar-container">\n        <a class="memberstats authorsMemberPageLink"><img src="<< avatar >>"></a>\n    </div>\n    <div class="comment-main-container">\n        <div class="comment-header">\n            <span class="comment-author">\n                <a class="author-link pro" href="/member/<<author>>"><<author>></a>\n                <span class="made-it-header comment-info hide"> made it!</span>\n                <span class="is-author comment-info hide">(author)</span>\n                <span class="is-reply hide">\n                    <i class="icon-caret-right comment-info"></i>\n                    <a class="reply-to" href="/member/<<replyAuthor>>"><<replyAuthor>></a>\n                </span>\n            </span>\n            <a class="action btn btn-mini pull-right replyToCommentBtn login-required" data-sourcea="comment:reply">Reply</a>\n            <span class="comment-date pull-right comment-info"><<commentTime>></span>\n        </div>\n        <div class="quarantine-message"></div>\n        <div class="comment-body-container">\n            <div class="comment-body"><<body>></div>\n            <div data-item-id="<< id >>" class="comment-photos"></div>\n        </div>\n        <div class="comment-files"></div>\n        <div class="comment-actions clearfix"></div>\n    </div>\n</div>';window.Ibles.JST["comment-list-item-actions"]='<span class="imadeit-checkbox pull-right hide action">\n    <input type="checkbox" class="imadeit-check" name=""/>IMadeIt\n</span>\n<span class="approved-checkbox pull-right hide action">\n    <input type="checkbox" class="approved-check" name=""/>Approved\n</span>\n<a class="action pull-right deleteThread hide">[delete thread]</a>\n<a class="action pull-right deleteComment hide">[delete]</a>\n<a class="action pull-right unquarantine-btn hide">[q-]</a>\n<a class="action pull-right limboBtn hide">[+l]</a>\n<[ if (Ibles.pageContext.ibleData.lessonId) { ]>\n    <a class="action pull-right limbo-class-projects hide">[limbo projects]</a>\n<[ } ]>\n<span class="sticky-comment-checkbox pull-right hide action">\n    <input type="checkbox" class="sticky-check" name=""/>Feature Comment\n</span>\n<div class="action pull-right dropdown flagComment hide">\n    <a class="dropdown-toggle" data-toggle="dropdown" href="#">Flag</a>\n    <ul class="dropdown-menu">\n        <li><a data-flagname="not_nice">Not Nice</a></li>\n        <li><a data-flagname="inappropriate">Inappropriate</a></li>\n        <li><a data-flagname="spam">Spam</a></li>\n    </ul>\n</div>\n<img class="request-img pull-right hide" src="/static/img/spinner.gif" height=\'10\' width=\'10\'/>\n<img class="request-success pull-right hide" src="/static/img/ico_check.gif" height=\'10\' width=\'10\'/>\n<img class="request-failure pull-right hide" src="/static/img/ico_cross.gif" height=\'10\' width=\'10\'/>';window.Ibles.JST["comment-image-file"]='<a class="comment-photos-link" rel="fancybox-thumb-<< commentId >>" href="<< largeUrl >>" data-fancybox-href="/file/ << id >>">\n    <img class="photo fancybox-thumb" alt="Picture of << name >>" data-image-id="<< id >>" data-notes=\'<< imageNotes >>\' data-orig-height="<< height >>" data-orig-width="<< width >>" src="<< square2Url >>"/>\n</a>';window.Ibles.JST["comment-attached-file"]='<a href="<< originalUrl >>">\n    <img src="<< tinyUrl >>" alt=""/>\n    <span class="entryExtraTitle"><< name >></span>\n</a>';window.Ibles.JST["imadeit-modal"]='<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>\n<div class="modal-body">\n    <img src="/static/img/robot.png" width="100"/>\n    <div>\n        <p>We noticed you attached photos<br/>to your comment.</p>\n        <h2>Did you make this instructable?</h2>\n    </div>\n    <div class="two-buttons">\n        <button class="btn btn-large imadeit-no" data-dismiss="modal">\n            <i class="bg-icon instructable"></i>\n            No, just adding photos.\n        </button>\n        <button class="btn btn-large btn-primary btn-orange imadeit-yes">\n            <i class="bg-icon imadeit white"></i>\n            Yes, I made it!\n        </button>\n    </div>\n</div>';window.Ibles.JST["statscard"]='<div class="statscard">\n    <[ if (data.instructablesCount) { ]>\n    <div class="header clearfix">\n        <div class="col main-stat"><span class="count instructables-count"><< data.instructablesCount >></span><br/> Instructables</div>\n        <[ if (data.publishedCollectionsCount) { ]>\n        <div class="col main-stat"><span class="count collections-count"><< data.publishedCollectionsCount >></span><br/> Collections</div>\n        <[ } ]>\n        <div class="col other-stats">\n            <div class="views"><i class="icon-views1"></i> <span class="count"><< data.views >></span> Views</div>\n            <div class="favorites"><i class="icon-favorite"></i> <span class="count"><< data.favoritesCount >></span> Favorited</div>\n        </div>\n    </div>\n    <[ } ]>\n    <div class="body">\n        <div class="author-box clearfix">\n            <div class="author-image">\n                <a href="/member/<< encodeURIComponent(data.screenName) >>/">\n                    <img src="<< data.square2Url >>"/>\n                </a>\n            </div>\n            <div class="author-details">\n                <div class="screen-name">\n                    <a href="/member/<< encodeURIComponent(data.screenName) >>/"><< data.screenName >></a>\n                </div>\n                <div class="signup-info">\n                    Joined << data.signup >> <[ if (data.pro) { ]><img src="/static/img/statscard/pro.gif"/><[ } ]>\n                </div>\n                <div class="follow">\n                    <a class="btn btn-yellow follow-btn login-required" data-sourcea="statscard:follow" data-followtxt="Follow" data-followingtxt="Following" data-unfollowtxt="Unfollow">\n                        <[ if (data.following) { ]>\n                            <i class="bg-icon checkmarksmall active"></i>&nbsp; <span>Following</span>\n                        <[ } else { ]>\n                            <i class="bg-icon plus active"></i>&nbsp; <span>Follow</span>\n                        <[ } ]>\n                    </a>\n                    <span class="callout"><< data.followersCount >></span>\n                </div>\n                <div class="private-message">\n                    <a class="btn" href="/edit/compose?recipientId=<< data.id >>&amp;linkTo=/member/<< encodeURIComponent(data.screenName) >>/"><i class="bg-icon email"></i>Message</a>\n                </div>\n            </div>\n        </div>\n        <[ if (data.about && data.about.length > 0) { ]>\n            <div class="bio">\n                <a href="/member/<< encodeURIComponent(data.screenName) >>/"><span class="ibl">Bio:</span> << data.about >></a>\n            </div>\n        <[ } ]>\n    </div>\n</div>';window.Ibles.JST["statscard-wrapper"]='<div class="popover statscard-popover"><div class="arrow"></div><div class="popover-content"></div></div>';window.Ibles.JST["achievement"]='<i style="display:none" class="achievement achievement-featured icon-featured"></i>\n<i style="display:none" class="achievement achievement-comments icon-comments"></i>\n<i style="display:none" class="achievement achievement-views icon-views1"></i>\n<div style="display:none" class="achievement-popover-wrapper">\n    <div style="display:none" class="coin-wrapper coin-featured-wrapper">\n        <p></p>\n        <i class="achievement-coin achievement-coin-featured"></i>\n    </div>\n    <div style="display:none" class="coin-wrapper coin-comments-wrapper">\n        <p></p>\n        <i class="achievement-coin achievement-coin-comments"></i>\n    </div>\n    <div style="display:none" class="coin-wrapper coin-views-wrapper">\n        <p></p>\n        <i class="achievement-coin achievement-coin-views"></i>\n    </div>\n</div>';Ibles.package("Ibles.models");Ibles.models.CommentModel=Backbone.Model.extend({defaults:function(){var ibleData=Ibles.pageContext.ibleData;return{instructableId:ibleData?ibleData.id:null,author:Ibles.session.get("screenName"),authorId:Ibles.session.get("id"),authorUrl:null,avatar:Ibles.session.get("tinyUrl"),fileSet:new Ibles.collections.FileCollection,IMadeIt:false,replyAuthor:null,quarantine:false,limbo:false,status:null,commentable:null}},initialize:function(){if(!_.isUndefined(this.get("publishDate"))){this.set({commentTime:this.setRelDate()})}if(_.isEmpty(this.get("authorUrl"))){this.set({authorUrl:Ibles.reverseUrls.memberUrl(this.get("author"))})}if(!_.isEmpty(this.get("files"))){this.get("fileSet").add(this.get("files"))}if(this.get("status")==="DELETED"){this.setDeletedBody()}},setRelDate:function(){var publishDate=this.get("publishDate");var pubDate=new Date(publishDate),newDate=new Date(moment());if(pubDate>newDate){return Ibles.attemptTranslationOfString("a few seconds ago")}else{return moment(publishDate).fromNow()}},setDeletedBody:function(){this.set({body:Ibles.attemptTranslationOfString("(removed by author or community request)")})},postCommentAction:function(){var that=this,params=_.pick(this.toJSON(),"instructableId","author","IMadeIt","body","inReplyTo"),promise,fileSet=this.get("fileSet");if(!fileSet.isEmpty()){if(_.isFunction(fileSet.idArray)){params.images=fileSet.idArray()}else{params.images=fileSet.map(function(file){return{id:file.get("id")}})}}promise=Ibles.API.jsonPostRequest("addComment",params,{success:function(data){that.set({id:data["id"],commentTime:"a few seconds ago",publishDate:moment().fromNow()});that.trigger("comment.postSuccess",that);if(Ibles.COMMENTCOLLECTION){if(_.isUndefined(that.get("inReplyTo"))){Ibles.COMMENTCOLLECTION.add(that,{at:0})}else{Ibles.COMMENTCOLLECTION.add(that,{at:Ibles.COMMENTCOLLECTION.findIndexOfComment(that.get("inReplyTo"))+1});Ibles.COMMENTCOLLECTION.dirtyTree=true}}},error:function(data){var errorMessage;if(data&&data["validationErrors"]){var errorKeys=Object.keys(data.validationErrors);if(errorKeys.length>1){errorMessage=Ibles.locale.errors.incompleteFormError}else{errorMessage=data.validationErrors[errorKeys[0]]}}else{errorMessage=Ibles.toLocaleError(data,Ibles.locale.errors.somethingWentWrong)}that.trigger("comment.postError",errorMessage)}},"id");return promise},deleteComment:function(){var that=this;return Ibles.API.postRequest("deleteComment",{id:this.get("id")},{success:function(data){if(that.collection.getChildrenArray(that).length>0){that.setDeletedBody()}else{that.collection.remove(that)}}})},deleteThread:function(){var that=this;return Ibles.API.postRequest("deleteThread",{id:this.get("id")},{success:function(data){that.collection.deleteThread(that)}})},setIMadeIt:function(value){var options={id:this.get("id"),value:value},promise=$.ajax({url:"/json-api/setIMadeIt",dataType:"json",type:"POST",data:options});return promise},flagComment:function(flagName){var self=this,params={id:this.get("id"),flag:flagName};return Ibles.API.postRequest("setFlag",params)},limbo:function(){var params={action:"LIMBO",objectIds:this.get("id"),type:"C"},that=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){that.set({limbo:true})}})},unquarantine:function(){var params={action:"PUBLISH",objectIds:this.get("id"),type:"C"},self=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){self.set({quarantine:false,status:"PUBLISHED"})}})},toggleStickyComment:function(sticky){var params={entryID:this.get("id"),type:"FORUM_COMMENT"},that=this;return Ibles.API.ajaxRequest("sticky",params,{success:function(data){that.set({sticky:sticky})}})},toggleApproval:function(checked){var status=checked===true?"CHECKED":"UNCHECKED",params={entryID:this.get("id"),status:status},that=this;return Ibles.API.ajaxRequest("approve",params,{success:function(data){that.set({approved:checked})}})}});Ibles.package("Ibles.collections");Ibles.collections.CommentCollection=Backbone.Collection.extend({dirtyTree:false,model:Ibles.models.CommentModel,offset:0,defaults:{numCommentsToLoad:50},initialize:function(models,options){_.bindAll(this,"deleteThread","getChildrenArray");this.options=_.extend(this.defaults,options)},findIndexOfComment:function(id){return this.indexOf(this.findWhere({id:id}))},deleteThread:function(model){var children=this.getChildrenArray(model),parents=this.getParents(model);this.remove(children);this.remove(model);this.remove(parents)},parseComments:function(comments){return _.map(comments,function(comment){if(_.isUndefined(comment.author)){comment.author=null;comment.authorUrl="/"}return comment})},fetchComments:function(){if(!this.dirtyTree){var that=this,id=Ibles.pageContext.ibleData.id,deferred=Ibles.API.getRequest("getComments",{instructableId:id,limit:this.options.numCommentsToLoad,offset:this.length},{success:function(data){that.add(that.parseComments(data.comments))}});return deferred}else{return this.reloadCommentTree()}},reloadCommentTree:function(){var that=this,id=Ibles.pageContext.ibleData.id,deferred=Ibles.API.getRequest("getComments",{instructableId:id,limit:this.options.numCommentsToLoad+this.length,offset:0},{success:function(data){that.reset(that.parseComments(data.comments))}});return deferred},getParents:function(model){var that=this,parents=[],getParent=function(model){var parentId=model.get("inReplyTo");if(!_.isUndefined(parentId)){parents.push(parentId);getParent(that.get(parentId))}else{return parents}};return getParent(model)},getChildrenArray:function(model){var that=this,children=[],getChildren=function(model){var levelChildren=that.where({inReplyTo:model.get("id")});if(levelChildren.length>0){children=children.concat(_.pluck(levelChildren,"id"));_.each(levelChildren,getChildren)}};getChildren(model);return children}});Ibles.package("Ibles.views");Ibles.views.CommentView=Backbone.View.extend({quarantineMessage:"THIS COMMENT HAS BEEN QUARANTINED",className:function(){if(_.isUndefined(this.model.get("inReplyTo"))){return"comment-container clearfix"}else{return"comment-container reply clearfix"}},setSubviews:function(){this.replyView=Ibles.views.ReplyPostingView},template:_.template(Ibles.JST["comment-list-item"]),actionsTemplate:_.template(Ibles.JST["comment-list-item-actions"]),imageTemplate:_.template(Ibles.JST["comment-image-file"]),fileTemplate:_.template(Ibles.JST["comment-attached-file"]),events:{"click .replyToCommentBtn":"renderReplyUI","click .imadeit-check":"setIMadeItAction","click .deleteComment":"deleteCommentAction","click .deleteThread":"deleteThreadAction","click .flagComment .dropdown-menu a":"flagComment","click .limboBtn":"limboComment","click .unquarantine-btn":"unquarantineComment","click .sticky-check":"toggleSticky","click .approved-check":"toggleApproval","click .reply-to":"scrollToParent","click .limbo-class-projects":"limboClassProjects"},defaults:{showStatsCard:true},initialize:function(){_.bindAll(this,"remove");this.options=_.extend({},this.defaults,this.options);this.setSubviews();this.setUpAchievements();this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"remove",this.remove)},setUpAchievements:function(){this.achievements=window.Ibles.ACHIEVEMENTS;this.achievements.addAuthor(this.model.get("authorId"))},render:function(){if((this.model.get("limbo")||this.model.get("quarantine"))&&!Ibles.session.authenticated()){this.$el.hide();return this.$el}this.$el.html(this.template(this.model.toJSON()));if((this.model.get("limbo")||this.model.get("quarantine")&&!Ibles.session.isAdmin())&&this.model.get("author")!==Ibles.session.get("screenName")){this.$el.hide()}if(Ibles.session.authenticated()){this.$(".comment-actions").html(this.actionsTemplate())}if(Ibles.session.isAdmin()){this.$(".deleteComment,.deleteThread,.limbo-class-projects,.imadeit-checkbox,.limboBtn,.sticky-comment-checkbox,.approved-checkbox").show();if(this.model.get("quarantine")){this.$(".quarantine-message").html(this.quarantineMessage);this.$(".unquarantine-btn").show()}}else if(Ibles.session.authenticated()){this.$(".flagComment").show()}if(Ibles.pageContext.ibleData){if(this.model.get("author")===Ibles.pageContext.ibleData.author.screenName){this.$(".is-author").show();this.$(".comment").addClass("highlight")}}if(this.model.get("author")===Ibles.session.get("screenName")){this.$(".deleteComment").show()}if(!this.model.get("fileSet").isEmpty()){this.renderFiles()}else{this.$(".comment-files,.comment-photos").hide()}if(this.model.get("IMadeIt")===true){this.$(".comment-author").addClass("imadeit");this.$(".imadeit-check").prop("checked",true);this.$(".made-it-header").show()}if(this.model.get("sticky")===true){this.$(".sticky-check").prop("checked",true)}if(this.model.get("approved")===true){this.$(".approved-check").prop("checked",true)}if(this.model.collection&&!_.isUndefined(this.model.get("inReplyTo"))&&_.isNull(this.model.get("replyAuthor"))){var parentComment=this.model.collection.get(this.model.get("inReplyTo"));if(!_.isEmpty(parentComment)){this.model.set({replyAuthor:parentComment.get("author")})}}this.attachAuthorAchievements();if(this.options.showStatsCard===true){this.attachStatsCard()}this.attachCommentImagesFancybox();return this.$el},attachAuthorAchievements:function(){var self=this;var authorId=this.model.get("authorId");this.achievements.fetchForAuthor(authorId).done(function(authorStats){var achievementView=new Ibles.views.Achievement({model:new Backbone.Model(_.extend(authorStats,{authorId:authorId}))});self.$(".achievement-holder").html(achievementView.render().el);if(self.$(".author-achievements").is(":visible")){self.$(".imadeit").addClass("has-achievement")}})},attachStatsCard:function(){this.$(".memberstats").statscard({loginURL:"/account/login",screenName:this.model.get("author")})},renderFiles:function(){var imageTemplate=this.imageTemplate,fileTemplate=this.fileTemplate,that=this;this.model.get("fileSet").each(function(file){file.set({commentId:that.model.get("id")});if(_.isUndefined(file.get("height"))||file.get("image")===false){that.$(".comment-files").append(fileTemplate(file.toJSON()))}else{that.$(".comment-photos").append(imageTemplate(file.toJSON()))}})},renderReplyUI:function(e){if(e)e.preventDefault();var that=this;Ibles.checkLoginThen(function(){$(".comment-container .post-comment-container").remove();var reply=new Ibles.models.CommentModel({inReplyTo:that.model.get("id"),replyAuthor:that.model.get("author")}),replyView=new that.replyView({model:reply});that.$(".comment").after(replyView.render());$("html, body").animate({scrollTop:that.$el.offset().top},1e3)},{sourcea:"comments:reply"})},setIMadeItAction:function(e){var that=this;this.showRequestFeedback(this.model.setIMadeIt(this.$(".imadeit-check").is(":checked")))},deleteCommentAction:function(e){var response=confirm(Ibles.attemptTranslationOfString("Are you sure you want to delete this comment?"));if(response){this.showRequestFeedback(this.model.deleteComment())}},deleteThreadAction:function(){var response=confirm(Ibles.attemptTranslationOfString("Are you sure you want to delete this thread?"));if(response){this.showRequestFeedback(this.model.deleteThread())}},flagComment:function(e){this.showRequestFeedback(this.model.flagComment($(e.currentTarget).data("flagname")))},limboComment:function(e){this.showRequestFeedback(this.model.limbo())},unquarantineComment:function(e){this.showRequestFeedback(this.model.unquarantine())},toggleSticky:function(e){this.showRequestFeedback(this.model.toggleStickyComment($(e.currentTarget).prop("checked")))},toggleApproval:function(e){this.showRequestFeedback(this.model.toggleApproval($(e.currentTarget).prop("checked")))},showRequestFeedback:function(promise){var that=this;this.$(".request-img").show();promise.then(function(){that.$(".request-img").hide();that.$(".request-success").show();that.$(".request-success").fadeOut()}).fail(function(){that.$(".request-img").hide();that.$(".request-failure").show();that.$(".request-failure").fadeOut()})},scrollToParent:function(e){e.preventDefault();if(!_.isUndefined(this.model.get("inReplyTo"))){var $parent=$("#comment-"+this.model.get("inReplyTo")),scrollPos=$parent.offset().top-$("#ible-header.fixed").outerHeight();if(scrollPos<window.scrollTop){$("body,html").animate({scrollTop:scrollPos},"fast")}}},attachCommentImagesFancybox:function(){this.$(".comment-photos-link").fancybox()}});Ibles.views.BaseCommentPostingView=Backbone.View.extend({events:{"click .post-comment-btn":"sendComment","click .addCommentImages":"attemptUpload","click .comment-imadeit-toggle":"toggleIMadeIt"},defaults:{showIMadeIt:true},initialize:function(){this.options=_.extend({},this.defaults,this.options)},render:function(){var that=this;this.$el.html(this.template(this.model.toJSON()));this.redactorView=new Ibles.views.RedactorTextAreaView({el:this.$(".redactor-container"),sourcea:"comments:redactor",redactorLoadedCallback:function(){that.instantiateImageBucket(".redactor_box")}});return this.$el},instantiateImageBucket:function(textarea){var ible=Ibles.pageContext.ibleData,isExternal=!!(ible.showUrl||"").match(/\/design\//);this.imageBucket=new Ibles.views.ImageBucketView({el:this.$(".image-bucket"),source:"comments:addimage",collection:this.model.get("fileSet"),textarea:this.$(textarea),multiple:true,directUpload:isExternal});if(isExternal){this.setupImageBucketLoadingIndicators()}},setupImageBucketLoadingIndicators:function(){this.listenTo(this.imageBucket,"imagebucket:uploading",_.bind(function(){this.$(".addCommentImages").button("loading")},this));this.listenTo(this.imageBucket,"imagebucket:uploadcomplete",_.bind(function(){this.$(".addCommentImages").button("reset")},this));this.listenTo(this.imageBucket,"imagebucket:uploaderror",_.bind(function(){this.$(".addCommentImages").button("reset")},this))},sendComment:function(e){if(Ibles.session.authenticated()){e.preventDefault();var bodyText=this.$(".postCommentBody").val();this.model.set({body:bodyText.replace(/\n/g,"<br>")});if(!this.model.get("fileSet").isEmpty()&&!this.model.get("IMadeIt")&&this.options.showIMadeIt){this.showImadeItPrompt()}else{this.postComment()}}},postComment:function(){var postCommentBtn=this.$(".post-comment-btn");postCommentBtn.prop("disabled",true);return this.model.postCommentAction().then(this.onSend).always(function(){postCommentBtn.prop("disabled",false)})},showImadeItPrompt:function(){var self=this;new Ibles.views.ImadeItConfirmModal({model:this.model,selectionCallback:function(){self.postComment()}}).render()},toggleIMadeIt:function(e){},attemptUpload:function(e){if(Ibles.session.authenticated()){e.preventDefault();this.imageBucket.addImages()}},showPostingError:function(errorMessage){var alert=new Ibles.models.AlertModel({alertType:"error",alertMessage:errorMessage});new Ibles.views.AlertLabelView({el:this.$(".comment-error"),model:alert})}});Ibles.views.ReplyPostingView=Ibles.views.BaseCommentPostingView.fullExtend({template:_.template(Ibles.JST["post-comment"]),initialize:function(){_.bindAll(this,"sendComment","onSend");this._super();this.listenTo(this.model,"comment.postError",this.showPostingError)},onSend:function(){this.$el.remove();var achievements=window.Ibles.ACHIEVEMENTS;if(achievements)achievements.fetch()}});Ibles.views.CommentPostingView=Ibles.views.BaseCommentPostingView.extend({el:"#topLevelCommentField",template:_.template(Ibles.JST["post-comment-top-level"]),initialize:function(options){_.bindAll(this,"sendComment","onSend");this._super(options);this.manager=options&&options.manager;this.model=new Ibles.models.CommentModel;this.render();this.listenTo(this.model,"change:IMadeIt",this.updateIMadeItButton);this.listenTo(this.model,"comment.postError",this.showPostingError)},toggleIMadeIt:function(e){var that=this;e.preventDefault();Ibles.checkLoginThen(function(){that.model.set({IMadeIt:!that.model.get("IMadeIt")})},{sourcea:"comments:toggleIMadeIt"})},updateIMadeItButton:function(){var that=this;if(this.model.get("IMadeIt")){this.$(".comment-imadeit-toggle").addClass("active");if(this.model.get("fileSet").isEmpty()){this.$(".imadeit-image-warning").show();this.$(".imadeit-image-warning button.close").click(function(e){that.$(".imadeit-image-warning").hide()})}}else{this.$(".comment-imadeit-toggle").removeClass("active")}},onSend:function(){this.undelegateEvents();this.$el.empty();this.stopListening();this.imageBucket.destroy();new this.constructor({manager:this.manager})}});Ibles.package("Ibles.views");Ibles.views.CommentManager=Backbone.View.extend({el:"#commentsWrapper",defaults:{showPopover:true},events:{"click #see-more-comments":"addComments"},numCommentsToLoad:50,initialize:function(){_.bindAll(this,"addComments","renderComment","scrollToComment");this.options=_.extend({},this.defaults,this.options);this.setSubviews();this.$("#loaded-comments").remove();window.Ibles.COMMENTCOLLECTION=new Ibles.collections.CommentCollection([],{numCommentsToLoad:this.numCommentsToLoad});this.collection=window.Ibles.COMMENTCOLLECTION;this.addComments();new this.postingView({manager:this});this.initializeAchievements();this.listenToOnce(this,"commentsRendered",this.scrollToComment);this.listenTo(this.collection,"add",this.renderComment);this.listenTo(this.collection,"reset",this.reRenderAllComments)},setSubviews:function(){this.postingView=Ibles.views.CommentPostingView;this.commentView=Ibles.views.CommentView},initializeAchievements:function(){var options={showPopover:this.options.showPopover};window.Ibles.ACHIEVEMENTS=new Ibles.models.Achievements(options);this.achievements=window.Ibles.ACHIEVEMENTS},addComments:function(){var that=this;if(!_.isUndefined(this.achievements)){this.achievements.clearAuthors()}this.collection.fetchComments().done(function(data){if(data.comments.length<that.collection.options.numCommentsToLoad){$("#see-more-comments").hide()
}if(!_.isUndefined(that.achievements)){that.achievements.fetch()}that.trigger("commentsRendered")})},renderComment:function(comment){var view=new this.commentView({model:comment,manager:this}),comments=this.$("#comment-list .comment-container"),commentIndex=comment.collection.indexOf(comment);if(commentIndex===0){$("#comment-list").prepend(view.render())}else if(commentIndex===comments.length){$("#comment-list").append(view.render())}else{comments.eq(commentIndex).before(view.render())}},reRenderAllComments:function(){this.$("#comment-list").css({"min-height":$("#comment-list").outerHeight()});this.$("#comment-list").empty();this.collection.each(this.renderComment);this.$("#comment-list").css({"min-height":"initial"})},scrollToComment:function(){if(window.location.search.match(/^\?comments=all/)){var id=window.location.hash.slice(1);if(this.collection.get(id)){var scrollPosition=$("#comment-"+id).offset().top-$("#ible-header").outerHeight();$(document).scrollTop(scrollPosition)}}}});Ibles.package("Ibles.views");Ibles.views.ImadeItConfirmModal=Backbone.View.extend({className:"imadeit-modal modal hide fade",model:null,template:_.template(Ibles.JST["imadeit-modal"]),events:{"click .imadeit-yes":"setImadeIt","click .imadeit-no":"unsetImadeIt"},initialize:function(options){this.selectionCallback=options&&options.selectionCallback;this.$el.html(this.template());$("body").append(this.$el)},setImadeIt:function(e){e.preventDefault();this.model.set({IMadeIt:true});this.afterToggle()},unsetImadeIt:function(e){e.preventDefault();this.model.set({IMadeIt:false});this.afterToggle()},afterToggle:function(){this.$el.modal("hide");if(_.isFunction(this.selectionCallback))this.selectionCallback()},render:function(){var self=this;this.$el.one("hidden.bs.modal",function(e){self.remove()});this.$el.modal("show")}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.Achievements=Backbone.Model.extend({deferred:null,authorIds:[],initialize:function(options){var self=this;this.deferred=$.Deferred();if(options&&options.authorIds){this.authorIds=options.authorIds}},addAuthor:function(authorId){this.authorIds.push(authorId)},clearAuthors:function(){this.set({authorIds:[]})},fetch:function(){var self=this;if(this.authorIds&&this.authorIds.length){Ibles.API.getRequest("getAuthorsStats",_.map(this.authorIds,function(authorId){return{name:"id",value:authorId}}),{success:function(data){self.set(data);self.deferred.resolve(data)},error:function(){self.deferred.reject()}})}},fetchForAuthor:function(authorId){var deferred=$.Deferred(),self=this;this.deferred.done(function(data){var authorStats=data["authorsStats"];if(authorStats.hasOwnProperty(authorId)){deferred.resolve(authorStats[authorId])}else{deferred.resolve({})}}).fail(function(){deferred.reject({})});return deferred.promise()}});Ibles.views.Achievement=Backbone.View.extend({achievementCriteria:{views:{bronze:1e4,silver:1e6,gold:1e7},comments:{bronze:100,silver:500,gold:1e3},featured:{bronze:1,silver:10,gold:100}},template:_.template(Ibles.JST["achievement"]),defaults:{showPopover:false},className:"author-achievements",initialize:function(){this.options=_.extend({},this.defaults,this.options)},attributes:function(){return{"data-toggle":"popover",style:"display:none"}},render:function(){this.$el.html(this.template());this.renderAchievements();return this},renderAchievements:function(){var properties={views:this.model.get("totalInstructableViews")+this.model.get("totalGuidesViews"),featured:this.model.get("featuredInstructablesCount")+this.model.get("featuredGuideCount"),comments:this.model.get("numCommentsMade")},authorId=this.model.get("authorId"),self=this;for(var key in properties){if(properties.hasOwnProperty(key)){self.addAchievement(authorId,key,properties[key])}}if(this.options.showPopover){this.$el.popover({container:"body",placement:"top",trigger:"hover",html:true,content:this.$(".achievement-popover-wrapper").html(),template:'<div class="popover achievement-popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'})}},addAchievement:function(authorId,achievementType,authorStatProperty){var achievementCriteria=this.achievementCriteria;if(authorStatProperty>=achievementCriteria[achievementType].gold){this.renderMedallion("gold",achievementType)}else if(authorStatProperty>=achievementCriteria[achievementType].silver){this.renderMedallion("silver",achievementType)}else if(authorStatProperty>=achievementCriteria[achievementType].bronze){this.renderMedallion("bronze",achievementType)}},renderMedallion:function(medalType,achievementType){var $achievementWrapper=this.$el,$achievementIcon=$achievementWrapper.find(".achievement-"+achievementType),$achievementPopoverWrapper=$achievementWrapper.find(".achievement-popover-wrapper"),$achievementPopoverCoinWrapper=$achievementPopoverWrapper.find(".coin-"+achievementType+"-wrapper"),$achievementCoinIcon=$achievementPopoverWrapper.find("i.achievement-coin-"+achievementType);if(medalType==="gold"||medalType==="silver"||medalType==="bronze"){$achievementIcon.addClass("coin-"+medalType).show();$achievementCoinIcon.addClass("coin-"+achievementType+"-"+medalType);$achievementPopoverCoinWrapper.css("display","inline-block");if($achievementWrapper.is(":hidden"))$achievementWrapper.show()}}});!function($,_){var StatsCard=function(el,options){this.init(el,options)};StatsCard.prototype={constructor:StatsCard,template:_.template(Ibles.JST["statscard"]),init:function(el,options){this.$element=$(el);this.screenName=this.$element.data("screenname")?this.$element.data("screenname"):options.screenName;this.loginURL=options.loginURL;this.author=null;this.intentTimeout=null;this.options=$.extend({placement:"right",trigger:"manual",html:true});this.createPopover({content:Ibles.locale.uiElements.loading})},createPopover:function(options){this.$element.popover($.extend({},this.options,options)).hover($.proxy(this.mouseInTrigger,this),$.proxy(this.mouseOut,this))},getPopover:function(){return this.$element.data("popover")},getPopoverContainer:function(){return this.$element.data("popover").tip()},showPopover:function(){this.getPopover().show()},fetchAuthor:function(callback){if(!this.contentRequested){var apiParams={lite:"true",screenName:this.screenName};$.get("/json-api/showAuthor?"+$.param(apiParams),function(data){callback(data)});this.contentRequested=true}},getStatscardContent:function(){if(!this.signupDateFormated){this.author.signup=moment(this.author.signup.split(" ")[0]).format("MMM Do YYYY");this.signupDateFormated=true}if(!this.countsFormatted){var viewCount=this.author.views,favoritesCount=this.author.favoritesCount;this.author.views=numeral(viewCount).format("0,0");this.author.favoritesCount=numeral(favoritesCount).format("0,0");this.countsFormatted=true}return this.template({data:this.author})},mouseInTrigger:function(e){var that=this;this.hovering=true;this.intentTimeout=setTimeout(function(){if(that.hovering){that.getPopover().show();that.fetchAuthor(function(data){that.author=data;that.author.following=typeof data.following!=="undefined"&&data.following;that.getPopover().destroy();that.createPopover({content:$.proxy(that.getStatscardContent,that),template:Ibles.JST["statscard-wrapper"]});that.showPopover();that.getPopoverContainer().hover($.proxy(that.mouseInPopover,that),$.proxy(that.mouseOut,that));that.enableFollowing()})}},250)},mouseInPopover:function(e){this.hovering=true},mouseOut:function(e){this.hovering=false;var that=this;clearTimeout(this.intentTimeout);clearTimeout(this.persistenceTimeout);this.persistenceTimeout=setTimeout(function(){if(!that.hovering){that.$element.popover("hide")}},500)},enableFollowing:function(){var that=this;this.getPopoverContainer().on("click",".follow-btn",function(e){var followBtn=$(e.currentTarget);followBtn.addClass("disabled");followBtn.children("span").html(Ibles.locale.uiElements.loading);$.ajax({url:"/json-api/"+(that.author.following?"unfollowAuthor":"followAuthor"),dataType:"json",type:"POST",data:{screenName:that.screenName}}).done(function(data){var isFollowing=data.isFollowing;that.author.following=isFollowing;if(isFollowing){that.author.followersCount++}else{that.author.followersCount--}}).fail(function(jqXHR,textStatus){if(jqXHR.status===401)window.location.href=that.loginURL}).complete(function(){followBtn.removeClass("disabled");followBtn.fadeOut(400,function(){followBtn.children("span").html(that.author.following?followBtn.data("followingtxt"):followBtn.data("followtxt"));followBtn.children(".bg-icon").removeClass("checkmarksmall plus").addClass(that.author.following?"checkmarksmall":"plus");followBtn.fadeIn(400)});var countContainer=followBtn.closest(".follow").find(".callout"),followCount=that.author.followersCount;countContainer.text(followCount)})})}};$.fn.statscard=function(option){return this.each(function(){var $this=$(this),data=$this.data("statscard"),options=typeof option=="object"&&option;if(!data)$this.data("statscard",data=new StatsCard(this,options))})};$.fn.statscard.Constructor=StatsCard}(window.jQuery,window._);window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["lesson-project-list-item"]='<hr/>\n<div class="comment" id="comment-<<id>>">\n    <div class="comment-header">\n        <div class="header-details clearfix">\n            <div class="member-thumbnail">\n                <a class="memberstats authorsMemberPageLink"><img src="<< avatar >>"></a>\n            </div>\n            <div class="member-tag">\n                <span class="mobile-reply hide">\n                    Reply by\n                </span>\n                <a class="author-link pro" href="/member/<<author>>"><<author>></a>\n                <span class="made-it-header comment-info hide"> made it!</span>\n                <span class="is-author comment-info hide">(author)</span>\n                <span class="is-reply hide">\n                    <i class="icon-caret-right comment-info"></i>\n                    <a class="reply-to" href="/member/<<replyAuthor>>"><<replyAuthor>></a>\n                </span>\n            </div>\n        </div>\n        <div class="comment-extras clearfix">\n            <a class="action btn comment-reply btn-mini replyToCommentBtn pro-required-course" data-sourcea="lesson:imadeItReply">Reply</a>\n            <div class="comment-info">\n                <<commentTime>>\n            </div>\n        </div>\n    </div>\n    <div class="quarantine-message"></div>\n    <div class="comment-body-container">\n        <div class="comment-body"><<body>></div>\n        <div  data-item-id="<< id >>" class="comment-photos"></div>\n    </div>\n    <div class="comment-files"></div>\n    <div class="comment-actions clearfix">\n    </div>\n</div>\n\n';window.Ibles.JST["lesson-post-project"]='<form class="post-comment-form" name="PostCommentForm">\n    <input class="commentFiles" name="files" type="hidden" value=""/>\n    <div class="post-comment-box clearfix">\n        <div class="post-comment-body redactor-container">\n            <div class="comment-tip redactor-tooltip" data-toggle="tooltip" data-placement="top" title="Highlight text to apply styling"></div>\n             <textarea id="project-notes" rows=\'5\' cols=\'50\' class="postCommentBody redactorAirComment redactor-textarea" name="content" placeholder="Tell us about your project..."></textarea>\n            <div class="alert alert-info imadeit-image-warning hide">\n                <button type="button" class="close">&times;</button>\n                Please include an image of what you made!\n            </div>\n            <div class="comment-error hide">\n            </div>\n        </div>\n        <div class="image-bucket instructable-image-bucket clearfix "></div>\n        <div class="post-comment-toolbar clearfix">\n            <div class="comment-actions note-buttons pull-right">\n                <button class="addCommentImages btn pro-required-course" data-loading-text="Uploading..." data-sourcea="lesson:iMadeItAddPhotos">Add Photos</button>\n                <button class="btn post-comment-btn btn-orange pro-required-course" data-sourcea="lesson:iMadeIt" data-loading-text="<i class=\'icon-spin icon-large\'></i>">I Made It!</button>\n            </div>\n        </div>\n    </div>\n</form>\n';window.Ibles.JST["project-post-reply"]='<div class="post-comment-container">\n    <form class="post-comment-form" name="PostCommentForm">\n        <input class="commentFiles" name="files" type="hidden" value=""/>\n        <div class="post-comment-box">\n            <div class="post-comment-body redactor-container">\n                <div class="comment-tip redactor-tooltip" data-toggle="tooltip" data-placement="top" title="Highlight text to apply styling"></div>\n                <textarea class="postCommentBody redactorAirComment redactor-textarea" name="content"></textarea>\n                <div class="comment-files hide"></div>\n            </div>\n            <div class="post-comment-toolbar clearfix">\n                <div class="actions note-buttons pull-right">\n                    <button class="addCommentImages btn login-required" data-loading-text="Uploading..." data-sourcea="project:addCommentImage">Add Images</button><button class="post-comment-btn btn btn-orange login-required" data-sourcea="project:postCommentReply" data-loading-text="<i class=\'icon-spin icon-large\'></i>">Reply</button>\n                </div>\n            </div>\n            <ul class="image-bucket instructable-image-bucket clearfix ui-sortable ui-droppable"></ul>\n        </div>\n    </form>\n</div>';Ibles.package("Ibles.views");Ibles.views.LessonCommentManager=Ibles.views.CommentManager.extend({el:"#project",numCommentsToLoad:2,lessonModel:null,initialize:function(options){this.lessonModel=options&&options.lessonModel;this.marker=new Ibles.models.LessonProjectMarkerModel;this._super();this.showCompletionNotice();this.listenTo(this.marker,"change:completed",this.showCompletionNotice)},showCompletionNotice:function(){if(this.marker.get("completed")){this.$(".project-notice.complete").show();this.$(".project-notice.incomplete").hide();this.$("#topLevelCommentField").hide()}else{this.$(".project-notice.complete").hide();this.$(".project-notice.incomplete").show();this.$("#topLevelCommentField").show()}},setSubviews:function(){this.postingView=Ibles.views.LessonCommentPostingView;this.commentView=Ibles.views.LessonCommentView},initializeAchievements:function(){}});Ibles.views.LessonCommentView=Ibles.views.CommentView.extend({template:_.template(Ibles.JST["lesson-project-list-item"]),initialize:function(options){this._super(options);this.manager=options&&options.manager},setSubviews:function(){this.replyView=Ibles.views.LessonReplyPostingView},attachAuthorAchievements:function(){},setUpAchievements:function(){},attachStatsCard:function(){},deleteCommentAction:function(e){var response=confirm(Ibles.attemptTranslationOfString("Are you sure you want to delete this comment?"));if(response){if(this.model.get("author")===Ibles.session.get("screenName")){this.manager.marker.undoCompleted()}this.showRequestFeedback(this.model.deleteComment())}},limboClassProjects:function(e){var limboAll=confirm("Do you want to limbo all projects by "+this.model.get("author")+" in this class ("+Ibles.pageContext.ibleData.containingCourse.title+")?");if(limboAll){var targetId=this.model.get("authorId"),promises=[];_.each(window.Ibles.pageContext.ibleData.containingCourse.instructables,function(ible){Ibles.API.getRequest("getComments",{instructableId:ible.id,limit:200}).then(function(data){_.each(data.comments,function(comment){if(comment.authorId===targetId&&!comment.limbo){var params={action:"LIMBO",objectIds:comment.id,type:"C"},limboPromise=Ibles.API.adminAjaxRequest("quarantine",params);promises.push(limboPromise)}})})});this.showRequestFeedback($.when.apply(this,promises))}}});Ibles.views.LessonReplyPostingView=Ibles.views.ReplyPostingView.fullExtend({template:_.template(Ibles.JST["project-post-reply"]),sendComment:function(e){e.preventDefault();var bodyText=this.$(".postCommentBody").val();this.model.set({body:bodyText.replace(/\n/g,"<br>")});this.postComment()},onSend:function(){this.$el.remove()}});Ibles.views.LessonCommentPostingView=Ibles.views.CommentPostingView.fullExtend({el:"#topLevelCommentField",template:_.template(Ibles.JST["lesson-post-project"]),initialize:function(options){_.bindAll(this,"sendComment","onSend");this.manager=options&&options.manager;this.model=new Ibles.models.CommentModel({IMadeIt:true});this.render();this.show();this.listenTo(this.model,"comment.postError",this.showPostingError)},show:function(){if(this.manager.lessonModel.userCanEnrollInCourse()&&!this.manager.marker.isCompleted())this.$el.show()},sendComment:function(e){if(this.manager.lessonModel.userCanEnrollInCourse()){e.preventDefault();var bodyText=this.$(".postCommentBody").val();if(bodyText.indexOf("redactor_placeholder")>-1){bodyText=""}this.model.set({body:bodyText.replace(/\n/g,"<br>")});this.postComment()}},attemptUpload:function(e){if(this.manager.lessonModel.userCanEnrollInCourse()){e.preventDefault();this.imageBucket.addImages()}},onSend:function(){this.markCompleted();this._super()},markCompleted:function(){var imageUrls=this.model.get("fileSet").map(function(file){return file.get("square3Url")});this.manager.marker.markCompleted({imageUrls:imageUrls})}});Ibles.package("Ibles.models");Ibles.models.LessonProjectMarkerModel=Ibles.models.LessonProgressMarkerModel.fullExtend({defaults:function(){return{id:null,images:[]}},getProgressId:function(){return"project"},isOptional:function(){return true}});window.Ibles.JST=window.Ibles.JST||{};var template=function(str){var fn=new Function("obj","var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(match,code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');");return fn};window.Ibles.JST["course-gopro-modal"]='<div class="auth-module modal fade hide auth-modal course-gopro-modal">\n    <div class="modal-body">\n        <[ if (dismissable) { ]>\n            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>\n        <[ } ]>\n        <div class="banner-section">\n            <img class="pro-feature-burst" src="<< Ibles.staticUrl(\'img/premium-burst.png\') >>"/>\n        </div>\n        <div class="features-section">\n            <div class="features-header gopro-header">\n                <p class="title strong">Classes are a Premium feature!</p>\n                <p class="subtitle subtle">Sign up today for:</p>\n            </div>\n            <div class="feature-list">\n                <div class="feature courses well">\n                    << Ibles.svg(\'key\') >>\n                    <p>Access to all our classes</p>\n                </div>\n                <div class="feature mobile-web well">\n                    << Ibles.svg(\'phone\') >>\n                    <p>Learn anywhere, anytime</p>\n                </div>\n                <div class="feature teacher well">\n                    << Ibles.svg(\'teacher\') >>\n                    <p>One-on-one help</p>\n                </div>\n            </div>\n            <div class="features-footer">\n                <p>Also enjoy PDF downloads, ad free browsing, partner discounts, and more with Premium!</p>\n            </div>\n        </div>\n        <a class="btn btn-large btn-primary btn-orange" href="<< Ibles.reverseUrls.payUrl() >>">I\'m in! &raquo;</a>\n    </div>\n</div>\n\n';window.Ibles.JST["course-gopro-signup-modal"]='<div class="auth-module modal fade hide auth-modal course-gopro-signup-modal">\n    <div class="modal-body">\n        <[ if (dismissable) { ]>\n            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>\n        <[ } ]>\n        <div class="gopro-header enroll-header">\n            <img class="graduation-robot" src="<< Ibles.staticUrl(\'img/graduation-robot.png\') >>"/>\n            <p class="enroll-message">Want to enroll? First step is to sign up!</p>\n        </div>\n        <div class="social-login-options">\n            <button class="btn btn-large btn-facebook" data-loading-text="<span class=\'grey-spinner\'></span>"><i class="social-icon icon-facebook"></i> Facebook</button>\n            <button class="btn btn-large btn-twitter " data-loading-text="<span class=\'grey-spinner\'></span>"><i class="social-icon icon-twitter"></i> Twitter</button>\n            <button class="btn btn-large btn-google btn-danger" data-loading-text="<span class=\'grey-spinner\'></span>"><i class="social-icon icon-gplus"></i> Google</button>\n        </div>        \n        <div class="divider"><span>OR</span></div>\n        <form class="auth-form register-form" action="<< Ibles.reverseUrls.signupUrl() >>" method="post">\n            <!--[if !IE]><!-->\n            <input type="email" name="email" placeholder="Email" data-msg-required="Please enter your email." data-rule-required="true" value=""/>\n            <div class="section">\n                <input class="username-field" data-validation-username-message="Username is already in use" type="text" name="screenName" placeholder="Username" data-msg-required="Please enter your username." data-rule-required="true"/>\n                <input type="password" name="password" placeholder="Password" data-msg-maxlength="Your password must be fewer than 100 characters long." data-msg-minlength="Your password must be at least 3 characters long." data-msg-required="Please enter your password" data-rule-maxlength="100" data-rule-minlength="3" data-rule-required="true"/>\n            </div>\n            <!--<![endif]-->\n            <!--[if IE]>\n            <input type="email" name="email" data-msg-required="Please enter your email." data-rule-required="true" value=""/>\n            <div class="section">\n                <input class="username-field" data-validation-username-message="Username is already in use" type="text" name="screenName" value="Username" data-msg-required="Please enter your username." data-rule-required="true"/>\n                <span class="label ie-password-label">Password</span><input class="ie-password-input"type="password" name="password" placeholder="Password" data-msg-maxlength="Your password must be fewer than 100 characters long." data-msg-minlength="Your password must be at least 3 characters long." data-msg-required="Please enter your password" data-rule-maxlength="100" data-rule-minlength="3" data-rule-required="true"/>\n            </div>\n            <![endif]-->\n            <div class="section">\n                <div class="recaptcha-container"></div>\n                    <p class="muted legal">\n                        By clicking "Sign me up!" you agree to our <a target="_blank" title="Terms of service" href="http://usa.autodesk.com/adsk/servlet/item?siteID=123112&amp;id=21959721">Terms</a>\n                        and to our <a target="_blank" title="Privacy Statement" href="http://www.autodesk.com/company/legal-notices-trademarks/privacy-statement">Privacy Statement</a>.\n                    </p>\n                </div>\n            <div class="signup-error-label error-label label label-important"></div>\n            <button type="submit" class="btn btn-large btn-primary btn-orange auth-action register" data-loading-text="<span class=\'orange-grey-spinner\'></span>">Sign me up!</button>\n        </form>\n        <p class="login-footer">\n            <a class="btn" href="<< Ibles.reverseUrls.loginUrl() >>">Already a member? Login &raquo;</a>\n        </p>\n    </div>\n</div>';Ibles.package("Ibles.views");Ibles.views.BaseLessonView=Ibles.views.BaseInstructableView.fullExtend({events:{"click .facebook-share-button":"shareOnFacebook","click .join-course-btn":"joinContainingCourse"},initialize:function(options){this._super(options);_.bindAll(this,"postEnrollment");this.renderDiscussion();this.renderLoggedOutPrompt();if(!Ibles.session.authenticated()){this.renderQuizzes();this.renderLessonHomework();this.setupComments();if(this.model.get("fullAccessFlag")){this.$(".join-course-btn").css("display","inline-block")}}this.maintainStepOnOrientationChange();this.listenTo(this.model,"userDataSyncedForLessonAndContainingCourse",this.afterUserDataSynced);this.listenTo(this.model.containingCourse.progress,"change:progressDetail",this.updateDropdownProgress);this.listenTo(this.model.containingCourse.progress,"courseEnrollment",this.postEnrollment)},afterUserDataSynced:function(){this.renderEnrollmentStatus();this.renderQuizzes();this.renderLessonHomework();this.setupComments();this.setupScrollProgressMarker();this.setupEnrollListener();this.setupCourseFinishedListener();this.markLessonInProgress();this.renderPercentComplete();this.renderLoggedInPaywall()},markLessonInProgress:function(){var lesson=this.model,lessonProgress=lesson.progress;if(lesson.userCanEnrollInCourse()&&!lesson.isFullAccessLesson()&&lessonProgress.notStarted()){lessonProgress.markStarted()}if(lesson.userCanEnrollInCourse()&&!lessonProgress.isCompleted()&&lessonProgress.allDetailsCompleted()){lessonProgress.markCompleted()}},maintainStepOnOrientationChange:function(){if(Ibles.isMobile()&&window.matchMedia){function markStepsRead(){$(".step-container").each(function(){var step=$(this);stepPosition=step.position().top-$(window).scrollTop();if(stepPosition<=0){step.addClass("read-past")}else{step.removeClass("read-past")}})}markStepsRead();$(window).scroll(_.debounce(function(){markStepsRead()},250));var mql=window.matchMedia("(orientation: portrait)");if(mql.addListener){mql.addListener(function(m){var lastStepRead=$(".step-container.read-past").last();if(lastStepRead.length){$("body,html").animate({scrollTop:$(".step-container.read-past").last().offset().top+20},"slow")}})}}},setupComments:function(){},setupEnrollListener:function(){this.listenTo(this.model.containingCourse.progress,"change:isEnrolled",_.bind(function(){this.renderEnrollmentStatus()},this))},setupCourseFinishedListener:function(){this.listenTo(this.model.containingCourse.progress,"change:progressStatus",_.bind(function(progress){if(progress.get("progressStatus")==="COMPLETE"){this.renderCourseCompletedModal()}},this))},renderPercentComplete:function(){this.updatePercentComplete();this.listenTo(this.model.progress.details,"change:completed",this.updatePercentComplete)},updatePercentComplete:function(){var percentComplete=Math.round(this.model.progress.percentComplete());this.$(".lesson-progress").html(percentComplete+"% complete").show()},renderEnrollmentStatus:function(){if(!this.model.isEnrolledUser()){this.$(".enrolled").hide();this.$(".not-enrolled").show()}else{this.$(".enrolled").show();this.$(".not-enrolled").hide()}},joinContainingCourse:function(e){if(this.model.userCanEnrollInCourse()&&!this.model.isEnrolledUser()){e.preventDefault();$(e.target).button("loading");this.model.containingCourse.join().done(this.postEnrollment)}},postEnrollment:function(){Ibles.mixpanel.trackEvent("Course Enrollment",{course:this.model.containingCourse.get("title"),referrer:document.referrer,lesson:this.model.get("title")})},renderDiscussion:function(){new Ibles.views.QAView({el:"#lesson-discussion",lessonModel:this.model})},parseJsonSnippet:function(jsonNode){var $jsonNode=$(jsonNode);try{var quizJson=JSON.parse($jsonNode.html())}catch(e){}return quizJson},renderQuizzes:function(){if(this.model.userCanViewLesson()){var quizIndex=1;_.each(this.$(".quiz-json"),function(jsonNode){var quizJson=this.parseJsonSnippet(jsonNode);if(!_.isEmpty(quizJson)){var quizModel=new Ibles.models.QuizModel(_.extend(quizJson,{index:quizIndex})),quizView=new Ibles.views.QuizView({model:quizModel,lessonModel:this.model});$(jsonNode).before(quizView.render().$el);quizIndex++}},this)}},renderLessonHomework:function(){if(this.model.userCanViewLesson()){_.each(this.$(".lesson-homework-json"),function(jsonNode){var homeworkJson=this.parseJsonSnippet(jsonNode);if(!_.isEmpty(homeworkJson)){var homeworkModel=new Ibles.models.LessonHomeworkModel(homeworkJson),homeworkView=new Ibles.views.LessonHomeworkView({model:homeworkModel,lessonModel:this.model});$(jsonNode).before(homeworkView.render().$el)}},this)}},setupScrollProgressMarker:function(){if(this.model.userCanEnrollInCourse()&&!this.model.progress.isCompleted()&&!this.model.progress.details.filterRequired().length){new Ibles.views.LessonScrollMarkerView}},renderLoggedOutPrompt:function(){var options={dismissable:false,returnUrl:Ibles.getCurrentUrl()};if(!Ibles.session.authenticated()&&!this.model.isFullAccessLesson()){if(this.model.isFullAccessCourse()){Ibles.showAuthPrompt(_.extend(options,{sourcea:"lessonSignupPrompt"}))}else{Ibles.showPremiumAuthPrompt(_.extend(options,{sourcea:"lessonGoproPrompt"}))}}},renderLoggedInPaywall:function(){if(Ibles.session.authenticated()&&!this.model.userCanViewLesson()){Ibles.showCourseGoproModal({sourcea:"lessonGoproPaywall",dismissable:false})}},renderCourseCompletedModal:function(){new Ibles.views.CourseCompletedModal({model:this.model.containingCourse})},updateDropdownProgress:function(model){var progressDetails=model.get("progressDetail");this.$(".lesson-dropdown-link").each(function(index){var id=$(this).data("lesson-id"),lesson=_.findWhere(progressDetails,{id:id});if(!_.isEmpty(lesson)){var status=lesson["status"];if(status==="IN_PROGRESS"){$(this).removeClass("finished").addClass("started")}else if(status==="COMPLETE"){$(this).removeClass("started").addClass("finished")}}})}});Ibles.package("Ibles.views");Ibles.views.LessonView=Ibles.views.BaseLessonView.fullExtend({initialize:function(options){this._super(options);this.render()},render:function(){this.setupStickyHeader();this.setupPhotosets();this.setupSyntaxHighlighting()},afterUserDataSynced:function(){this._super();this.setupAdminPanel()},setupStickyHeader:function(){var aboveNavbar=$("#gbl-header").outerHeight()+$(".lesson-header-inner").outerHeight();$(".fixed-header").affix({offset:{top:aboveNavbar,bottom:0}}).addClass("fade").removeClass("hide");var introPos=$(".lesson-intro").offset().top;$(window).scroll(function(){var scrollPos=introPos-$(window).scrollTop();if(scrollPos<10){$(".fixed-header").addClass("in")}else{$(".fixed-header").removeClass("in")}});$("#lesson-sticky-nav").find(".dropdown-toggle").on("click",function(){setTimeout(function(){if($(".lesson-dropdown").hasClass("open")){var $activeLesson=$(".lesson-preview").parent();if($activeLesson.length){var menuPosition=$activeLesson.position();$("#lesson-sticky-nav").find(".dropdown-menu").scrollTop(menuPosition.top-60)}}},10)})},setupComments:function(){if(this.model.get("commentingEnabled")===false){this.$(".class-project-comments").hide()}else{this.model.CommentManager=new Ibles.views.LessonCommentManager({lessonModel:this.model});if(this.model.get("comments")>=8){$("#see-more-class-comments").addClass("in")}}},setupPhotosets:function(){var $photosets=this.$(".photoset"),$firstPhotoset=$photosets.eq(0),options={maxRowsVisible:3,gutter:"5px",maxWidth:Ibles.pageContext.photosetLessonMaxWidth};if($firstPhotoset.length){new Ibles.views.PhotosetView(_.extend({el:$firstPhotoset,preloadImages:true},options))}_.each($photosets.slice(1),function($photoset){new Ibles.views.PhotosetView(_.extend({el:$photoset},options))
})},setupAdminPanel:function(){if(!Ibles.isMobile()&&Ibles.session.isAdmin()){head.load(Ibles.assets.admin(),function(){new Ibles.views.Admin({el:"#admin-container"})})}}});